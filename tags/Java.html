<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>JustAnOtherDevBlog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">    

    <!-- Le styles -->
    <link href="../css/yeti/bootstrap.min.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link href="../css/asciidoctor.css" rel="stylesheet">
    <!-- link href="/css/bootstrap-theme.min.css" rel="stylesheet" -->
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
    <link href='http://alexgorbatchev.com/pub/sh/3.0.83/styles/shCore.css' rel='stylesheet' type='text/css'/>
    <link href='http://alexgorbatchev.com/pub/sh/3.0.83/styles/shThemeDefault.css' rel='stylesheet' type='text/css'/>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">
  </head>
  <body>
    <div id="wrap">

	
	      <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-menu">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../index.html">JustAnOtherDevBlog</a>
          </div>
          <div class="collapse navbar-collapse" id="navbar-menu">
            <ul class="nav navbar-nav">
              <li><a href="https://github.com/ybonnel" target="github:ybonnel">Github</a></li>
              <li><a href="../feeds/posts/default">Flux RSS</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
      <div class="container">


	<div class="page-header">
            <div class="row">
                <div class="col-xs-4 col-md-2"><img src="../img/JustAnOtherDevBlog.png"></div>
                <div class="col-xs-12 col-md-8"><h1>Tag: Java</h1></div>
            </div>
	</div>

    <div class="row">

    <div class="col-sm-8">
        
            
                <a href="../2014/06/websocket-et-comment-on-teste.html"><h1>WebSocket, et comment on teste?</h1></a>
                <p>18 juin 2014</p>

                <p>Tags :
                <a href="Assertj.html">Assertj</a>, <a href="Awaitility.html">Awaitility</a>, <a href="Java.html">Java</a>, <a href="Jetty.html">Jetty</a>, <a href="SimpleWeb4j.html">SimpleWeb4j</a>, <a href="websocket.html">websocket</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2014/06/websocket-et-comment-on-teste.html" data-text="WebSocket, et comment on teste?" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2014/06/websocket-et-comment-on-teste.html"></div>

                <p><p>On a vu comment implémenter des websockets avec SimpleWeb4j dans un précédant <a href="http://www.ybonnel.fr/2014/06/websocket-et-simpleweb4j.html">article</a>, nous allons maintenant voir comment tester de manière automatisée la partie serveur websocket.</p><br/><h2>Librairies tierces</h2><p>Pour garder un code relativement propre, je vais utiliser trois librairies : <ul><li><a href="http://www.eclipse.org/jetty/documentation/current/jetty-websocket-client-api.html">websocket-client</a> : Client WebSocket en java.</li><li><a href="http://joel-costigliola.github.io/assertj/">assertj-core</a> : Librairie d'assertion "fluent"</li><li><a href="https://code.google.com/p/awaitility/">awaitility</a> : Librairie d'attente (pour gérer l'asynchrone)</li></ul></p><br/> <h2>Je veux faire quoi comme test?</h2><p>Je cherche à tester le code du billet précédant qui, pour rappel, était un système de chat. Le serveur de websocket reçoit donc des messages qu'il redistribue à tous les clients connectés.</p><p>Scénario de test : <ul><li>Ouverture d'une session 1.</li><li>Envoi d'un message par la session 1 (message 1).</li><li>Ouverture d'une session 2.</li><li>Envoi d'un message par la session 2 (message 2).</li><li>Envoi d'un message par la session 1 (message 3).</li><li>Fermeture de la session 1.</li><li>Envoi d'un message par la session 2 (message 4).</li><li>Fermeture de la session 2.</li>  </ul></p><p>Vérifications à faire : <ul><li>La session 1 a reçu 3 messages (les messages 1 à 3)</li><li>La session 2 a reçu 3 messages (les messages 2 à 4)</li></ul></p><br/> <h2>Code de test</h2><p>Assez parler, place au code. J'espère que les commentaires sont suffisants, si ce n'est pas le cas, n'hésitez pas à le dire j'en ajouterais.</p><script src="https://gist.github.com/ybonnel/fdc9348326e0667c52c7.js"></script>
</p>
                <p><a href="2014/06/websocket-et-comment-on-teste.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2014/05/services-rest-avec-simpleweb4j.html"><h1>Services REST avec SimpleWeb4J</h1></a>
                <p>30 mai 2014</p>

                <p>Tags :
                <a href="Java.html">Java</a>, <a href="json.html">json</a>, <a href="REST.html">REST</a>, <a href="SimpleWeb4j.html">SimpleWeb4j</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2014/05/services-rest-avec-simpleweb4j.html" data-text="Services REST avec SimpleWeb4J" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2014/05/services-rest-avec-simpleweb4j.html"></div>

                <p><p>Cet article est le deuxième article de la série sur <a href="http://www.ybonnel.fr/search/label/SimpleWeb4j">SimpleWeb4j</a></p> <p>Dans le <a href="http://www.ybonnel.fr/2014/05/simpleweb4j-quick-start.html">première article</a> on a vu comment démarrer SimpleWeb4j en une ligne de code, dans l'article d'aujourd'hui, nous allors voir comment exposer des services REST en json.</p> <h2>Premiers cas : exposer une String "Hello World"</h2> <p>J'espère que le code est suffisamment simple pour ne pas avoir besoin d'explication.</p> <script src="https://gist.github.com/ybonnel/bf0f34483d47d5ca8966.js"></script> <p>On peux voir qu le résultat est entouré de guillemets, ceci est du au fait que SimpleWeb4j transforme la chaîne de caractère en json.</p> <br/> <h2>Deuxième cas : utilisation d'une variable de route</h2> <script src="https://gist.github.com/ybonnel/b7b50206951e056a5403.js"></script> <p>Cet exemple mérite peut-être un peu plus d'explications. SimpleWeb4j permet d'ajouter des paramètres à la route, ces paramètres sont préfixés de ':'. Pour les récupérer on utilise le paramètre RouteParameters qui est le deuxième argument de notre lambda. Le premier argument quand à lui contient l'objet envoyé dans le request body de la requête, nous ne l'utilisons donc pas.</p> <br/> <h2>Troisième cas : objet complexe</h2> <p>Nous avons vu que renvoyer une chaîne de caractère était plutôt simple, voyons maintenant comment renvoyer un objet plus complexe.</p> <script src="https://gist.github.com/ybonnel/9116ffb1ef033e66af68.js"></script> <p>On peut donc voir que renvoyer un objet n'est pas plus compliqué, SimpleWeb4j s'occupe de transformer celui-ci en json</p> <br/><br/> <p>J'espère vous avoir donner envie de regarder SimpleWeb4j de plus près, si quelque chose vous manque, n'hésitez pas à le dire ou à faire une pull request sur <a href="https://github.com/ybonnel/SimpleWeb4j">github</a>.</p>
</p>
                <p><a href="2014/05/services-rest-avec-simpleweb4j.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2014/05/simpleweb4j-quick-start.html"><h1>SimpleWeb4J - quick start</h1></a>
                <p>28 mai 2014</p>

                <p>Tags :
                <a href="Java.html">Java</a>, <a href="SimpleWeb4j.html">SimpleWeb4j</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2014/05/simpleweb4j-quick-start.html" data-text="SimpleWeb4J - quick start" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2014/05/simpleweb4j-quick-start.html"></div>

                <p><p>Ceux qui me suivent connaissent sans doute déjà <a href="https://github.com/ybonnel/SimpleWeb4j">SimpleWeb4j</a>.  Il s'agit d'encore un framework web donc le but est de pouvoir faire du web en java de manière très simple.</p> <p>Je n'ai jamais écrit d'article sur SimpleWeb4j, je vais donc écrire une série d'articles sur ce sujet afin de vous montrer la simplicité de ce framework.</p> <p>Je vais commencer par le classique Quick Start, ou comment démarrer un serveur Web capable de servir des ressources statiques.</p> <h2>Dépendance maven</h2><p><script src="https://gist.github.com/ybonnel/c1168b5f71cb6076d733.js"></script></p> <h2>Ressources statiques</h2><p>Mettez vos ressources statiques au sein d'un package "public" dans votre classpath.</p> <h2>Classe main</h2><p>Il vous suffit ensuite de démarrer le serveur : <script src="https://gist.github.com/ybonnel/74d0fca77b718eb300c1.js"></script></p> <p>Et voilà, vous avez un serveur prêt sur http://localhost:9999, pas besoin de déclaration xml ou autre complexité, un simple appel à start suffit.</p>
</p>
                <p><a href="2014/05/simpleweb4j-quick-start.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2014/05/scheduler-en-java.html"><h1>Scheduler en Java</h1></a>
                <p>27 mai 2014</p>

                <p>Tags :
                <a href="ExecutorService.html">ExecutorService</a>, <a href="Java.html">Java</a>, <a href="simple.html">simple</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2014/05/scheduler-en-java.html" data-text="Scheduler en Java" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2014/05/scheduler-en-java.html"></div>

                <p><p>Si je vous demande comment déclencher une tache récurrente en Java, je suis sûr que certains d'entre vous répondront Quartz...</p> <p>Ceux qui répondent ça ne connaissent sans doute pas les ExecutorService de Java, et plus particulièrement l'interface <a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ScheduledExecutorService.html">ScheduledExecutorService</a> (apparue en Java 1.5...).</p> <p>Voici donc un petit exemple permettant d'afficher l'heure courante toute les secondes :</p><script src="https://gist.github.com/ybonnel/39b3e53dd3d914fab02a.js"></script> <p>Ne vous habituez pas à un article par jour, ça ne va pas durer :)</p>  
</p>
                <p><a href="2014/05/scheduler-en-java.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2014/05/un-cache-en-java.html"><h1>Un cache en java</h1></a>
                <p>26 mai 2014</p>

                <p>Tags :
                <a href="Java.html">Java</a>, <a href="java8.html">java8</a>, <a href="simple.html">simple</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2014/05/un-cache-en-java.html" data-text="Un cache en java" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2014/05/un-cache-en-java.html"></div>

                <p><p>Après bientôt un an sans écrire d'article, je vais essayer de me remettre à écrire des trucs... Je ne garanti pas que ce soit intéressant :)</p><p>Le premiers de cette renaissance sera sur les caches simples en Java.</p>Je parle ici de cache non révocable (j'en ai eu besoin très récemment). Voici la classe permettant de faire ceci :  <script src="https://gist.github.com/ybonnel/795a9f1ef0e08c9a585f.js"></script> <p>Vous l'aurez compris, cet article cherche a vous présenter la méthode <a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentHashMap.html#computeIfAbsent-K-java.util.function.Function-">ConcurrentHashMap.computeIfAbsent</a>, cette méthode est apparue en Java 8.</p><p>Cette dernière permet donc de remplir notre Map si la clé est absente, et ce de manière Thread safe!</p> <p>J'espère pouvoir publier le prochain article dans moins d'un an, à bientôt donc :)<p>
</p>
                <p><a href="2014/05/un-cache-en-java.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2013/02/code-story-la-selection-finale.html"><h1>Code Story : la sélection finale</h1></a>
                <p>25 février 2013</p>

                <p>Tags :
                <a href="CodeStory.html">CodeStory</a>, <a href="Devoxx.html">Devoxx</a>, <a href="Google.html">Google</a>, <a href="Java.html">Java</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2013/02/code-story-la-selection-finale.html" data-text="Code Story : la sélection finale" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2013/02/code-story-la-selection-finale.html"></div>

                <p><p>Si vous me suivez sur twitter, vous savez sans doute déjà que Jeudi dernier (21/02) avait lieu la finale de Code Story. Je vais tenter de vous raconter comment s'est passée cette soirée haute en stress</p> <h3>Le lieu</h3><p>Cette soirée s'est passée chez google à Paris. En tant que fanboy Google, ça suffisait déjà à faire de cette soirée une super soirée :)</p><p>Pour ceux qui ne connaissent pas les bureaux de Google, je peux vous dire un truc, c'est que ça fait envie. Pour vous faire baver, voici simplement la photo du "coin" fumeurs :</p><a href="http://4.bp.blogspot.com/-LNYFsSEdl_I/USsa3Iz2E1I/AAAAAAAAR-A/H7xqyc4RcbM/s1600/fumeurs_google.jpg" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-LNYFsSEdl_I/USsa3Iz2E1I/AAAAAAAAR-A/H7xqyc4RcbM/s320/fumeurs_google.jpg" /></a><br/><br/> <h3>Le déroulement</h3><p>Tout est expliqué sur le <a href="http://code-story.net/2013/02/21/concours-2013-phase-2.html">blog de Code Story</a>, voici cependant un petit résumé. On avait des <a href="http://code-story.net/data/codestory2013.json">données</a> avec pour chaque participant à Code Story, sa ville, trois trucs qu'il aime et deux trucs qu'il n'aime pas. Avec ça on devait construire un site internet from scratch permettant aux participants de connaître ceux avec qui ils ont des atomes crochus.</p><br/><h3>Notre participation</h3><p>Les participants étaient par binômes pour ce concours. J'étais pour ma part avec Alexandre Ardhuin (<a href="https://twitter.com/a14n">@a14n</a>).</p><p>Nous sommes arrivés les mains dans les poches sans rien avoir préparé (ce qui nous a sans doute fait défaut). La première étape a donc été de monter une stack Web et de publier ça pour que ce soit accessible sur Internet. Cette étape nous a pris à peu près 1 heure, à la moitié du temps nous avions donc un magnifique site web accessible sur Internet qui affichait "coucou"...</p><p>Pour afficher autre chose que "coucou", nous avons utilisé le framework Angular.js ce qui nous a permis d'afficher rapidement la liste des participants, le tout codé à l'arrache dans un seul fichier <a href="https://github.com/ybonnel/CodeStoryFinale/commit/baeb84020f14a608e3b114ef81bd8c51bd98e8f5">index.html</a></p><p>Alexandre est ensuite parti sur une présentation géographique des participants via Google Map, mais il n'a pas pu aller au bout à cause des quotas sur le geo-codage, dommage...</p><p>Je suis pour ma part parti sur le refactoring du code pour séparer Javascript, templates HTML et index.html afin de pouvoir mettre en place les routes Angular.js. Tout cela afin d'obtenir un lien par participant affichant les détails de celui-ci. Toutefois, je suis resté bloqué sur de la syntaxe Javascript pendant au moins 10 minutes :</p><p><pre class="brush:javascript"><br />angular.module('CodeStory');<br /></pre>différent de : <pre class="brush:javascript"><br />angular.module('CodeStory', []);<br /></pre>Dans le premiers cas, rien ne s'affiche, et l'erreur dans le console est : "Error: No module: CodeStory", en bref, un compilateur c'est pas si mal! </p><p>Ce refactoring m'a pris beaucoup de temps du coup (environ 20 minutes), et par conséquent il nous restait 25 minutes à peine pour faire la page de détail d'un participant. Nous avons mis environ 15 minutes à mettre en place une page affichant les personnes de la même ville, puis 7 minutes pour afficher les personnes ayant un "Like" en commun. Le "git push" permettant de déployer la dernière fonctionnalité a été fait sur le gong (heureusement qu'on avait un déploiement simplifié!).</p><p>Le code final est dispo sur <a href="https://github.com/ybonnel/CodeStoryFinale">github</a>.</p> <h3>Le résultat</h3><p>Une fois l'épreuve terminée, chaque binôme a eu 3 minutes pour présenter l'application aux jury. Nous sommes passés en premier, ce qui a permis de faire rapidement retomber le stress...</p><p>Au final c'est Xavier Hanin (<a href="https://twitter.com/xavierhanin">@Xavierhanin</a>) et Christophe Labouisse (<a href="https://twitter.com/XtlCnslt">@XtlCnslt</a>) qui ont gagné, et nous avons été second. Un grand bravo à eux, et je leur donne rendez-vous à Devoxx France pour les voir en action :)</p> <h3>Nos erreurs</h3><p>Notre première erreur a été de venir les mains dans les poches, il était prévisible que le Jury allait nous demander de coder une appli Web, si nous étions venus avec une stack Web prête à déployer, nous aurions gagné une heure...</p><p>N'ayant pas de stack web prête à déployer nous aurions dû partir sur un site directement hébergé sur github, n'ayant jamais utilisé le backend, cela aurait fait l'affaire, et nous aurions encore une fois gagné une heure...</p><p>Pour finir, voici : <ul><li>Ce que nous avons sorti à la fin du concours : <a href="http://serveur.ybonnel.fr:8080">http://serveur.ybonnel.fr:8080</a></li><li>Ce que nous aurions pu sortir avec l'heure de gagnée : <a href="http://ybonnel.github.com/CodeStoryFinale">http://ybonnel.github.com/CodeStoryFinale</a></li></ul>Pour les plus curieux le diff est dispo sur <a href="https://github.com/ybonnel/CodeStoryFinale/compare/f3b6d35e07172deae6d5322a8f4fab0059538a9d...gh-pages">github</a></p><br/><br/><p>Si vous avez eu le courage de lire jusque là, vous aurez peut-être le courage de regarder la <a href="http://www.youtube.com/watch?v=c26ORroLSAQ">vidéo</a>!</p> 
</p>
                <p><a href="2013/02/code-story-la-selection-finale.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2013/02/code-story-en-java-jajascript-et-les.html"><h1>Code Story en java : Jajascript et les performances</h1></a>
                <p>05 février 2013</p>

                <p>Tags :
                <a href="CodeStory.html">CodeStory</a>, <a href="Jajascript.html">Jajascript</a>, <a href="Java.html">Java</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2013/02/code-story-en-java-jajascript-et-les.html" data-text="Code Story en java : Jajascript et les performances" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2013/02/code-story-en-java-jajascript-et-les.html"></div>

                <p><style type="text/css"> .code {  margin: 0 2em 0 2em;  padding: 1em;  background: rgb(230,244,231);  border: 1px solid rgb(89,180,89);  white-space: pre-wrap; /* CSS3 */  white-space: -moz-pre-wrap; /* Mozilla, post millennium */  white-space: -pre-wrap; /* Opera 4-6 */  white-space: -o-pre-wrap; /* Opera 7 */  word-wrap: break-word; /* Internet Explorer 5.5+ */ }  </style> <p>Cet article est le dernier d'une série de trois articles sur ma participation à Code Story en Java. Les articles précédents sont : <ul><li><a href="www.ybonnel.fr/2013/02/ma-participation-codestory-en-java-intro.html">Ma participation à CodeStory en java : Intro</a></li><li><a href="http://www.ybonnel.fr/2013/02/codestory-en-java-scalaskel-et-la.html">CodeStory en java : Scalaskel et la calculette</a></li></ul>Je vais essayer de vous faire un retour sur l'étape qui a donné le plus de difficultés à tous les participants : Jajascript. </p> <h1>L'énoncé</h1><p>Voici l'énoncé tel que nous l'avons reçu : <div style="border:1px solid black"><blockquote><h2 id="location_dastronef_sur_jajascript">Location d’astronef sur Jajascript</h2></blockquote><blockquote><p>Votre cousin par alliance, Martin O. sur la planète Jajascript vient de monter sa petite entreprise de vol spatial privé: Jajascript Flight Rental. Il loue aux grosses corporations son astronef lorsqu’elles ont de fortes charges ou un pépin avec leurs propres appareils. Il s’occupe de la maintenance et de l’entretien de son petit astronef. Il ne pouvait s’en payer qu’un pour démarrer.</p> <p>Ces grosses corporations envoient des commandes de location qui consistent en un intervalle de temps, et le prix qu’ils sont prêts à payer pour louer l’astronef durant cet intervalle.</p> <p>Les commandes de tous les clients sont connues plusieurs jours à l’avance. Ce qui permet de faire un planning pour une journée. Les commandes viennent de plusieurs sociétés différentes et parfois elles se chevauchent. On ne peut donc pas toutes les honorer.</p> <p>Idéalement, il faut donc être capable de prendre les plus rentables, histoire de maximiser les gains de sa petite entreprise, et de s’acheter d’autres astronefs. Votre cousin passe des heures à trouver le planning idéal et vous demande <strong>pour un planning donné de calculer une solution qui maximise son gain</strong>.</p> <h3 id="exemple">Exemple</h3> <p>Considérez par exemple le cas où la JajaScript Flight Rental à 4 commandes :</p></blockquote><pre class="code"><code>MONAD42 : heure de départ 0, durée 5, prix 10<br />META18 : heure de départ 3, durée 7, prix 14<br />LEGACY01 : heure de départ 5, durée 9, prix 8<br />YAGNI17 : heure de départ 5, durée 9, prix 7</code></pre><blockquote><p>La solution optimale consiste à accepter MONAD42 et LEGACY01, et le revenu est de <code>10 + 8 = 18</code>. Remarquez qu’une solution à partir de MONAD42 et YAGNI17 est faisable (l’avion serait loué sans interruption de 0 à 14) mais non optimale car le bénéfice ne serait que de 17.</p> <h3 id="prcisions">Précisions</h3> <p>L’identifiant d’un vol ne dépasse jamais 50 caractères, les heures de départs, durée et prix sont des entiers positifs raisonnablement grands.</p> <h3 id="serveur">Serveur</h3> <p>Votre serveur doit répondre aux requêtes http POST de la forme <code>http://serveur/jajascript/optimize</code> avec un payload de la forme :</p></blockquote><pre class="code"><code>[<br />    { "VOL": "NOM_VOL", "DEPART": HEURE, "DUREE": DUREE, "PRIX": PRIX }, ...<br />]</code><br /></pre><blockquote><p>En reprenant l’exemple ci dessus :</p></blockquote><pre class="code"><code>[<br />    { "VOL": "MONAD42", "DEPART": 0, "DUREE": 5, "PRIX": 10 },<br />    { "VOL": "META18", "DEPART": 3, "DUREE": 7, "PRIX": 14 },<br />    { "VOL": "LEGACY01", "DEPART": 5, "DUREE": 9, "PRIX": 8 },<br />    { "VOL": "YAGNI17", "DEPART": 5, "DUREE": 9, "PRIX": 7 }<br />]</code></pre><blockquote><p>Vous devrez répondre le résultat suivant :</p></blockquote><pre class="code"><code>{<br />      "gain" : 18,<br />      "path" : ["MONAD42","LEGACY01"]<br />}</code></pre><blockquote><p>Le gain représentant la somme optimale, path représentant l’ordre des vols.</p> <p>Bons calculs !</p></blockquote></div><br/> <h1>Premier algo très naïf </h1><p>Le premier algo que j'ai pondu était très naïf, je calculais absolument toutes les solutions possibles (voir plusieurs fois chaque solution). Voici la méthode principale de l'époque : <pre class="brush:java"><br />private void calculate(Planning actualPlanning, Collection<Commande> commandesToAdd) {<br />    if (actualPlanning != null) {<br />        addToPlanningsIfBetter(actualPlanning);<br />    }<br />    for (Commande commandeToAdd : commandesToAdd) {<br />        if (actualPlanning == null || actualPlanning.canAddCommande(commandeToAdd)) {<br />            Planning newPlanning = new Planning(actualPlanning);<br />            newPlanning.addCommande(commandeToAdd);<br />            Collection<Commande> newCommandesToAdd =<br />                Collections2.filter(commandesToAdd, new FilterCommande(commandeToAdd));<br />            calculate(newPlanning, newCommandesToAdd);<br />        }<br />    }<br />}<br /></pre>Dans cet algo récursif, je parcours toutes les commandes, et pour chaque commande, je regarde si elle est compatible à mon planning actuel, si elle l'est je l'ajoute au planning et je fais l'appel récursif. Cet algo est donc ni élégant ni performant, mais a le mérite de marcher. Pour les étapes précédentes cela suffisait, je me suis donc arrêté là, enfin jusqu'à la surprise. </p><br/> <h1>La surprise</h1><p>Pour Jajascript, ils nous ont fait une petite surprise, ils se sont mis à tester les performances... La méthode pour tester les performances était la suivante : le robot envoie une requête avec un certain nombre de commandes, si je réponds en moins de 30 secondes, il en envoie plus, et ce jusqu'à ce que je réponde en plus de 30 secondes. Voici la liste complète des marches utilisées par le robot : <ul><li>5 commandes</li><li>10 commandes</li><li>15 commandes</li><li>20 commandes</li><li>25 commandes</li><li>30 commandes</li><li>35 commandes</li><li>40 commandes</li><li>45 commandes</li><li>50 commandes</li><li>55 commandes</li><li>60 commandes</li><li>65 commandes</li><li>70 commandes</li><li>75 commandes</li><li>80 commandes</li><li>85 commandes</li><li>90 commandes</li><li>95 commandes</li><li>100 commandes</li><li>150 commandes</li><li>250 commandes</li><li>500 commandes</li><li>1000 commandes</li><li>1500 commandes</li><li>2000 commandes</li><li>2500 commandes</li><li>3000 commandes</li><li>3500 commandes</li><li>4000 commandes</li><li>5000 commandes</li><li>10000 commandes</li><li>50000 commandes</li></ul>Du coup mon premier algo naïf répondait en plus de 30 secondes à partir de 30 commandes (nous ne connaissions pas le max à l'époque qui semblait être aux alentours de 100 commandes). Il a donc fallu optimiser tout ça. Je ne vais pas vous présenter tous les commits d'optimisation par lesquels je suis passés (ça représente près de 50 commits...). Je vais plutôt tenter de vous montrer les grandes étapes ainsi que les performances associées. Pour les performances, je n'ai inclus que le calcul brut (sans la couche HTTP ou Json). </p><br/> <h1>Algo récursif optimisé</h1><p>Après quelques commits, je suis arrivé à un algo récursif un peu plus optimisé : <pre class="brush:java"><br />private void calculate(Planning actualPlanning, Collection<Commande> commandesToAdd) {<br />    if (actualPlanning != null) {<br />        addToPlanningsIfBetter(actualPlanning);<br />    }<br />    Iterator<Commande> itCommande = commandesToAdd.iterator();<br /><br />    while (itCommande.hasNext()) {<br />        Commande commandeToAdd = itCommande.next();<br />        itCommande.remove();<br />        if (actualPlanning == null || actualPlanning.canAddCommande(commandeToAdd)) {<br />            calculate(new Planning(actualPlanning).addCommande(commandeToAdd), newArrayList(commandesToAdd));<br />        }<br />    }<br />}<br /></pre>Les grosses différences pour en arriver là sont (pas toutes visibles dans le code ci-dessus) : <ul><li>Tri des commandes par heure de départ croissante</li><li>On ne stocke que le meilleur planning</li><li>On enlève la commande courante avant de continuer dans la récursivité</li><li>On stocke l'heure de fin d'un planning afin de savoir rapidement si une commande est compatible avec</li></ul>Pour les plus curieux, le diff complet est dispo sur <a href="https://github.com/ybonnel/CodeStory/compare/ae22a5854164e1f5f8a2fb68c0c1a3b1899ef7fb...906502717dbb9d9cd22e8e625a40c643a4dec868">github</a>. Cet algo tiens jusqu'à 70 commandes à peu près (c'est déjà beaucoup mieux, mais on est loin des 50000 commandes...). </p><br/> <h1>Algo récursif très optimisé</h1><p>Afin d'aller au bout des optimisations de l'algo récursif, j'ai modifié/enlevé tout ce qui prenait du temps sans changer l'algo. L'optimisation principale dans cette étape a été le passage en types primitifs avec utilisation de tableau d'entier. Quand on regarde le code obtenu, on a un peu l'impression de revoir du C... Toutes ces optimisations permettent tout de même d'atteindre les 5000 commandes environs. Pour les plus curieux, le diff complet est disponible sur <a href="https://github.com/ybonnel/CodeStory/compare/906502717dbb9d9cd22e8e625a40c643a4dec868...3a917905db23386d820f06ff68900a1a18884dcc">github</a>. </p><br/> <h1>Algo itératif</h1><p>Atteignant les limites du récursif, il a fallu passer à un algo itératif. Cet algo repose sur une pile des dernières solutions trouvées, afin de regarder dans ces solutions laquelle est la meilleure pour une commande donnée. Voici la méthode principale : <pre class="brush:java"><br />private void calculateIteratif() {<br />    // Parcours de toutes les commandes<br />    for (int i=0; i<nbCommands;i++) {<br />        Solution bestSolutionToAdd = null;<br />        int bestPrice = -1;<br />        for (Solution solution : lastSolutions) {<br />            if (starts[i] >= solution.heureFin<br />                    && solution.prix > bestPrice ) {<br />                bestSolutionToAdd = solution;<br />                bestPrice = solution.prix;<br />            }<br />        }<br /><br />        lastSolutions.removeFirst();<br /><br />        boolean[] newAceptedCommands = Arrays.copyOf(bestSolutionToAdd.acceptedCommands, bestSolutionToAdd.acceptedCommands.length);<br />        newAceptedCommands[i] = true;<br />        Solution newSolution = new Solution(ends[i], bestSolutionToAdd.prix + prices[i], newAceptedCommands);<br />        lastSolutions.addLast(newSolution);<br />    }<br /><br />    for (Solution solution : lastSolutions) {<br />        addToPlanningsIfBetter(solution.acceptedCommands, solution.prix);<br /><br />    }<br />}<br /></pre>Ce passage en itératif permet d'atteindre 200000 commandes environ (ce qui était suffisant pour le concours). Pour les plus curieux, le diff complet est disponible sur <a href="https://github.com/ybonnel/CodeStory/compare/3a917905db23386d820f06ff68900a1a18884dcc...002e7f474a8db0f85ae855926290b658740ec6b8">github</a></p><br/> <h1>Algo itératif optimisé</h1><p>Je vais maintenant vous présenter le code final obtenu après encore quelques optimisations, et finalement un retour à de l'objet pur (ce qui me fait perdre un peu en performance, mais rend le code tellement plus lisible). Avant d'arriver à ce résultat, je suis passé par un BitSet plutôt qu'un tableau de booléens, ce qui m'avait fait gagner pas mal (classe à connaître donc). Si vous voulez voir tout les commits intermédiaires, ça se passe sur <a href="https://github.com/ybonnel/CodeStory/compare/002e7f474a8db0f85ae855926290b658740ec6b8...master">github</a>. </p><p>Voici tout d'abord la classe Solution permettant de stocker une solution trouvée : <pre class="brush:java"><br />import com.google.common.base.Optional;<br />import com.google.common.primitives.Ints;<br /><br />import java.util.LinkedList;<br />import java.util.List;<br /><br />public class Solution implements Comparable<Solution> {<br />    public final int price;<br />    public final int endTime;<br />    public final Optional<Solution> oldSolution;<br />    public final Flight newFlight;<br /><br />    Solution(int price, Optional<Solution> oldSolution, Flight newFlight) {<br />        this.price = price;<br />        this.oldSolution = oldSolution;<br />        this.newFlight = newFlight;<br />        this.endTime = newFlight.endTime;<br />    }<br /><br />    public List<Flight> getFlights() {<br /><br />        LinkedList<Flight> flights = new LinkedList<Flight>();<br />        flights.add(newFlight);<br /><br />        Optional<Solution> currentSolution = oldSolution;<br />        while (currentSolution.isPresent()) {<br />            flights.addFirst(currentSolution.get().newFlight);<br />            currentSolution = currentSolution.get().oldSolution;<br />        }<br /><br />        return flights;<br />    }<br /><br />    public boolean isBetterThan(Optional<Solution> bestSolutionToAdd) {<br />        return !bestSolutionToAdd.isPresent() || price > bestSolutionToAdd.get().price;<br />    }<br /><br />    @Override<br />    public int compareTo(Solution o) {<br />        return Ints.compare(price, o.price);<br />    }<br />}<br /></pre>Le point principal à noter dans cette classe, est la façon de stocker une solution. Plutôt que de stocker une image complète d'une solution, on stocke la solution précédente plus la commande qu'on lui a ajoutée. Cette technique permet d'économiser énormément de mémoire, mais permet également de diminuer énormément le coup de la création d'une solution (appel au constructeur). </p><p>Voici maintenant la classe JajascriptService contenant tout l'algo : <pre class="brush:java"><br />import com.google.common.base.Function;<br />import com.google.common.base.Optional;<br />import com.google.common.collect.Lists;<br /><br />import java.util.Collections;<br />import java.util.Iterator;<br />import java.util.LinkedList;<br />import java.util.List;<br /><br />public class JajascriptService {<br /><br />    /**<br />     * Flights to optimize.<br />     */<br />    private List<Flight> flights;<br />    /**<br />     * Last solutions found.<br />     */<br />    private LinkedList<Solution> lastSolutions = new LinkedList<Solution>();<br /><br /><br />    public JajascriptService(List<Flight> flights) {<br />        this.flights = flights;<br />        Collections.sort(this.flights);<br />    }<br /><br />    public JajaScriptResponse calculate() {<br /><br />        Solution solution = calculateSolution();<br /><br />        // Construct the path with the array of accepted flights.<br />        List<String> path = Lists.transform(solution.getFlights(), new Function<Flight, String>() {<br />            @Override<br />            public String apply(Flight input) {<br />                return input.getName();<br />            }<br />        });<br /><br />        return new JajaScriptResponse(solution.price, path);<br />    }<br /><br />    private static class BestSolutions {<br />        Optional<Solution> bestCompatibleSolution = Optional.absent();<br />        Optional<Solution> bestSolutionWithEquivalentEndTime = Optional.absent();<br /><br />        int getPriceOfCompatibleSolution() {<br />            return getPriceOfAnOptionalSolution(bestCompatibleSolution);<br />        }<br /><br />        int getPriceOfEquivalentEndTimeSolution() {<br />            return getPriceOfAnOptionalSolution(bestSolutionWithEquivalentEndTime);<br />        }<br /><br />        private static int getPriceOfAnOptionalSolution(Optional<Solution> optionalSolution) {<br />            return optionalSolution.isPresent() ? optionalSolution.get().price : 0;<br />        }<br />    }<br /><br />    /**<br />     * @return an optimal solution.<br />     */<br />    private Solution calculateSolution() {<br />        // Iterate on all flights.<br />        for (Flight flight : flights) {<br />            // Pre-calculate endTime for future needs.<br />            flight.calculateEndTime();<br /><br />            BestSolutions bestSolutions = getBestSolutionsForAFlight(flight);<br /><br />            int newPrice = flight.price + bestSolutions.getPriceOfCompatibleSolution();<br /><br />            if (newPrice > bestSolutions.getPriceOfEquivalentEndTimeSolution()) {<br />                // Add the new solution to FIFO only if it's better than other solution with lower or equal endTime.<br />                lastSolutions.addLast(new Solution(newPrice, bestSolutions.bestCompatibleSolution, flight));<br />            }<br /><br />            if (bestSolutions.bestCompatibleSolution.isPresent()) {<br />                // If we found a compatible solution, we remove all solution with endTime lower than last flight startTime and lower price.<br />                removeOldSolutions(flight.startTime, bestSolutions.bestCompatibleSolution.get().price);<br />            }<br />        }<br /><br />        // Search the best solution in FIFO.<br />        Collections.sort(lastSolutions);<br />        return lastSolutions.getLast();<br />    }<br /><br />    /**<br />     * Remove all solution with lower or equal endTime than lastStartTime and lower price than priceOfCompatibleSolution.<br />     */<br />    private void removeOldSolutions(int lastStartTime, int priceOfCompatibleSolution) {<br />        Iterator<Solution> lastSolutionIterator= lastSolutions.iterator();<br /><br />        while (lastSolutionIterator.hasNext()) {<br />            Solution oldSolution = lastSolutionIterator.next();<br />            if (oldSolution.endTime <= lastStartTime<br />                    && oldSolution.price < priceOfCompatibleSolution) {<br />                lastSolutionIterator.remove();<br />            }<br />        }<br />    }<br /><br />    /**<br />     * Get the best solution in {@link JajascriptService#lastSolutions} for a flight.<br />     */<br />    private BestSolutions getBestSolutionsForAFlight(Flight flight) {<br />        BestSolutions bestSolutions = new BestSolutions();<br />        // Search the best solution in FIFO we can take for this flight.<br />        for (Solution solution : lastSolutions) {<br />            if (flight.startTime >= solution.endTime && solution.isBetterThan(bestSolutions.bestCompatibleSolution)) {<br />                bestSolutions.bestCompatibleSolution = Optional.of(solution);<br />            }<br />            if (flight.endTime >= solution.endTime && solution.isBetterThan(bestSolutions.bestSolutionWithEquivalentEndTime)) {<br />                bestSolutions.bestSolutionWithEquivalentEndTime = Optional.of(solution);<br />            }<br />        }<br />        return bestSolutions;<br />    }<br />}<br /></pre>Cette version étant plutôt bien commentée, je vous laisse lire les commentaires... </p><p>Au final, cette version permet de traiter 1 000 000 de commandes en 200 millisecondes. </p><br/> <h1>Différences entre les algos</h1><p>En guise de récapitulatif, voici un petit graphique avec les performances de tous les algos</p><div id="perf-timeline"></div> <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script><script src="http://cdnjs.cloudflare.com/ajax/libs/highcharts/2.3.1/highcharts.js"></script><script>var chart = new Highcharts.Chart({  chart: {   renderTo: 'perf-timeline',   type: 'line'  },  title: {   text:'Performances Jajascript'  },  xAxis: {   title: {    text:'Nb commandes'   }  },  yAxis: {   title: {    text:'Temps (ms)'   }  },  series: [   {    "name":"Récursif",    "data": [     [5,10],     [10,0],     [15,1],     [20,3],     [25,6],     [30,29],     [35,8],     [40,23],     [45,105],     [50,369],     [55,787],     [60,3684],     [65,6703],     [70,13297]    ]   },   {    "name":"Récursif optimisé",    "data":[     [5,21],     [10,0],     [15,0],     [20,0],     [25,0],     [30,0],     [35,0],     [40,0],     [45,0],     [50,0],     [55,0],     [60,0],     [65,0],     [70,0],     [75,0],     [80,0],     [85,1],     [90,1],     [95,2],     [100,2],     [150,0],     [250,1],     [500,21],     [1000,112],     [1500,303],     [2000,572],     [2500,1338],     [3000,2089],     [3500,3239],     [4000,5015],     [5000,11039]    ]   },   {    "name":"Itératif",    "data":[     [5,21],     [10,0],     [15,0],     [20,0],     [25,0],     [30,0],     [35,0],     [40,0],     [45,0],     [50,1],     [55,0],     [60,0],     [65,0],     [70,0],     [75,3],     [80,1],     [85,1],     [90,1],     [95,0],     [100,0],     [150,0],     [250,1],     [500,1],     [1000,3],     [1500,3],     [2000,4],     [2500,6],     [3000,10],     [3500,8],     [4000,11],     [5000,11],     [10000,34],     [50000,634],     [100000,1929],     [200000,7786],     [500000,54630]    ]   },   {    "name":"Itératif optimisé",    "data":[     [5,11],     [10,0],     [15,0],     [20,0],     [25,0],     [30,0],     [35,0],     [40,0],     [45,0],     [50,0],     [55,0],     [60,0],     [65,0],     [70,0],     [75,0],     [80,0],     [85,0],     [90,0],     [95,0],     [100,0],     [150,1],     [250,1],     [500,3],     [1000,7],     [1500,4],     [2000,3],     [2500,3],     [3000,6],     [3500,4],     [4000,4],     [5000,4],     [10000,4],     [50000,19],     [100000,32],     [200000,49],     [500000,100],     [1000000,197],     [1500000,272],     [2000000,533],     [2500000,2280],     [3000000,3046],     [3500000,1045],     [4000000,1049],     [4500000,1235],     [5000000,4606],     [5500000,10630],     [6000000,15386]    ]   }  ] }); </script><br/><br/><br/> <p>J'espère que ce retour sur ma participation à ce concours passionnant vous a plu. J'espère avoir le temps de vous faire un petit retour sur ma participation en <a href="https://github.com/ybonnel/CodeStory-ceylon">Ceylon</a> et en <a href="https://github.com/ybonnel/CodeStory-scala">Scala</a>, mais je ne vous garantis rien... </p>  
</p>
                <p><a href="2013/02/code-story-en-java-jajascript-et-les.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2013/02/codestory-en-java-scalaskel-et-la.html"><h1>CodeStory en java : Scalaskel et la calculette</h1></a>
                <p>04 février 2013</p>

                <p>Tags :
                <a href="CodeStory.html">CodeStory</a>, <a href="Groovy.html">Groovy</a>, <a href="Java.html">Java</a>, <a href="Scalaskel.html">Scalaskel</a>, <a href="TDD.html">TDD</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2013/02/codestory-en-java-scalaskel-et-la.html" data-text="CodeStory en java : Scalaskel et la calculette" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2013/02/codestory-en-java-scalaskel-et-la.html"></div>

                <p><style type="text/css"> .code {  margin: 0 2em 0 2em;  padding: 1em;  background: rgb(230,244,231);  border: 1px solid rgb(89,180,89);  white-space: pre-wrap; /* CSS3 */  white-space: -moz-pre-wrap; /* Mozilla, post millennium */  white-space: -pre-wrap; /* Opera 4-6 */  white-space: -o-pre-wrap; /* Opera 7 */  word-wrap: break-word; /* Internet Explorer 5.5+ */ }  </style>  <p>Cet article fait suite à l'article <a href="http://www.ybonnel.fr/2013/02/ma-participation-codestory-en-java-intro.html">Ma participation à CodeStory en java : Intro</a>.<br/>Le but de cet article va être de vous parler de deux étapes du concours CodeStory : Scalaskel et la Calculette en vous présentant mon implémentation en Java. </p><br/> <h1>Scalaskel</h1><p>Voici l'énoncé tel que nous l'avons reçu par POST : </p> <div style="border:1px solid black"><blockquote><h2 id="lchoppe_de_monade_sur_scalaskel">L’échoppe de monade sur Scalaskel.</h2> <p>Sur la planète Scalaskel, une planète en marge de la galaxie, aux confins de l’univers, la monnaie se compte en cents, comme chez nous. 100 cents font un groDessimal. Le groDessimal est la monnaie standard utilisable partout sur toutes les planètes de l’univers connu. C’est un peu compliqué à manipuler, mais si on ne s’en sert pas y’a toujours des erreurs d’arrondis incroyables quand on les soustrait ou on les divise, c’est idiot, mais c’est comme ça. Sur Scalaskel, on utilise rarement des groDessimaux, on utilise des pièces plus petites : Le <strong>Foo</strong> vaut <strong>1 cent</strong>, le <strong>Bar</strong> vaut <strong>7 cents</strong>, le <strong>Qix</strong> vaut <strong>11 cents</strong> et le <strong>Baz</strong> vaut <strong>21 cents</strong>.</p> <p>Vous tenez une échoppe de monade et autres variables méta-syntaxiques sur Scalaskel. Pour faire face à l’afflux de touristes étrangers avec les poches remplies de groDessimaux vous avez besoin d’écrire un programme qui pour toute somme de 1 à 100 cents, vous donnera toutes les décompositions possibles en pièces de <strong>Foo</strong>, <strong>Bar</strong>, <strong>Qix</strong> ou <strong>Baz</strong>.</p> <p>Par exemple, 1 cent ne peut se décomposer qu’en une seule pièce <strong>Foo</strong>. Par contre 7 cents peuvent se décomposer soit en 7 pièces <strong>Foo</strong>, soit en 1 pièce <strong>Bar</strong>.</p> <h2 id="serveur_web_">Serveur Web :</h2> <p>Votre serveur doit répondre aux requêtes http GET de la forme <code>http://serveur/scalaskel/change/X</code>, <code>X</code> étant une valeur en cents de 1 à 100 cents.</p> <p>La réponse attendue est un json de la forme :</p></blockquote><pre class="code"><code>[{“foo”: w, “bar”: x, “qix”: y, “baz”: z}, …]</code></pre><blockquote><p>Exemples Pour <code>http://serveur/scalaskel/change/1</code> il faut répondre :</p></blockquote><pre class="code"><code>[ {“foo”: 1} ]</code></pre><blockquote><p>Pour <code>http://serveur/scalaskel/change/7</code> il faut répondre :</p></blockquote><pre class="code"><code>[ {“foo”: 7}, {“bar”: 1} ]</code></pre><blockquote><p>L’ordre des valeurs dans le tableau json, ainsi que le formatage n’a pas d’importance à partir du moment où c’est du json valide, il s’entend.</p> <p>Bon courage !</p></blockquote></div><p>Première chose à mettre en place, le test unitaire (et oui, même si on est pressé, le TDD c'est bien) : <pre class="brush:java"><br />import com.meterware.httpunit.WebConversation;<br />import com.meterware.httpunit.WebResponse;<br /><br />import static org.junit.Assert.assertEquals;<br /><br />public class ScalaskelTest extends WebServerTestUtil {<br /><br />    @Test<br />    public void should_answer_to_1cent() throws Exception {<br />        WebConversation wc = new WebConversation();<br />        WebResponse response = wc.getResponse(getURL() + "/scalaskel/change/1");<br />        assertEquals(200, response.getResponseCode());<br />        assertEquals("[{\"foo\":1}]", response.getText());<br />    }<br /><br />    @Test<br />    public void should_answer_to_7cent() throws Exception {<br />        WebConversation wc = new WebConversation();<br />        WebResponse response = wc.getResponse(getURL() + "/scalaskel/change/7");<br />        assertEquals(200, response.getResponseCode());<br />        assertEquals("[{\"foo\":7},{\"bar\":1}]", response.getText());<br />    }<br /><br />    @Test<br />    public void should_answer_to_11cent() throws Exception {<br />        WebConversation wc = new WebConversation();<br />        WebResponse response = wc.getResponse(getURL() + "/scalaskel/change/11");<br />        assertEquals(200, response.getResponseCode());<br />        assertEquals("[{\"foo\":11},{\"foo\":4,\"bar\":1},{\"qix\":1}]", response.getText());<br />    }<br /><br />    @Test<br />    public void should_answer_to_21cent() throws Exception {<br />        WebConversation wc = new WebConversation();<br />        WebResponse response = wc.getResponse(getURL() + "/scalaskel/change/21");<br />        assertEquals(200, response.getResponseCode());<br />        assertEquals("[{\"foo\":21},{\"foo\":14,\"bar\":1},{\"foo\":10,\"qix\":1},{\"foo\":7,\"bar\":2},{\"foo\":3,\"bar\":1,\"qix\":1},{\"bar\":3},{\"baz\":1}]", response.getText());<br />    }<br />}<br /></pre>Rien d'extraordinaire dans ce test, il contient seulement les cas basiques (en même temps, le calcul à la main est assez chiant comme ça). </p><p>Si vous avez lu l'article précédent, vous savez que mon code en l'état ne gère pas les requêtes par path du type "/scalaskel/change/1", commençons donc par là. Dans la même idée que le "QueryHandler" présenté dans l'article précendent, j'ai d'abord créé un "PathHandler" : <pre class="brush:java"><br />import fr.ybonnel.codestory.WebServerResponse;<br />import javax.servlet.http.HttpServletRequest;<br /><br />public abstract class AbstractPathHandler {<br />    public abstract WebServerResponse getResponse(HttpServletRequest request, String payLoad, String... params) throws Exception;<br />}<br /></pre>La "request" sert à récupérer deux choses : la méthode (GET/POST) et le path. Le payload est utile pour les énoncés et jajascript (données envoyées en POST). Et pour finir les params sont le résultat de l'application d'un pattern que nous verrons ensuite. </p><p>Tout comme pour les Query, j'ai mis en place un enum relativement proche, mis à part qu'il n'a pas de méthodes abstraites. Cet enum gère de manière générique le routage avec la méthode et un pattern. Voici le code complet de cet enum : <pre class="brush:java"><br />import fr.ybonnel.codestory.WebServerResponse;<br />import javax.servlet.http.HttpServletRequest;<br />import javax.servlet.http.HttpServletResponse;<br />import java.util.regex.Matcher;<br />import java.util.regex.Pattern;<br /><br />public enum PathType {<br /><br />    INSERT_ENONCE(new InsertEnonceHandler(), "/enonce/(\\d+)", "POST"),<br />    GET_ENONCES(new GetEnoncesHandler(), "/enonce(/)*", "GET"),<br />    SCALASKEL_CHANGES(new ChangeScalaskelHandler(), "/scalaskel/change/(\\d+)", "GET"),<br />    JAJASCRIPT(new OptimizeJajascriptHandler(), "/jajascript/optimize.*", "POST");<br /><br />    private AbstractPathHandler handler;<br /><br />    private Pattern pathPattern;<br />    private String method;<br /><br />    PathType(AbstractPathHandler handler, String pathPattern, String method) {<br />        this.handler = handler;<br />        this.pathPattern = Pattern.compile(pathPattern);<br />        this.method = method;<br />    }<br /><br /><br />    public Matcher isThisPath(String method, String path) {<br />        if (this.method.equals(method)) {<br />            return pathPattern.matcher(path);<br />        } else {<br />            return null;<br />        }<br />    }<br /><br />    public static WebServerResponse getResponse(HttpServletRequest request, String payLoad) throws Exception {<br />        for (PathType onePath : values()) {<br />            Matcher isThisPath = onePath.isThisPath(request.getMethod(), request.getPathInfo());<br />            if (isThisPath != null && isThisPath.matches()) {<br />                return onePath.handler.getResponse(request, payLoad, extractParameters(isThisPath));<br />            }<br />        }<br />        return new WebServerResponse(HttpServletResponse.SC_NOT_FOUND, "This path is unknown");<br />    }<br /><br />    private static String[] extractParameters(Matcher thisPath) {<br />        String[] params = new String[thisPath.groupCount()];<br />        for (int groupIndex = 1; groupIndex &lt;= thisPath.groupCount(); groupIndex++) {<br />            params[groupIndex - 1] = thisPath.group(groupIndex);<br />        }<br />        return params;<br />    }<br />}<br /></pre></p><p>Maintenant que nous avons vu la tuyauterie, passons à l'algo de Scalaskel en lui-même. Au niveau modèle, j'ai deux classes, une représentant une solution (Change), et un enum représentant les pièces : <pre class="brush:java"><br />import com.fasterxml.jackson.annotation.JsonProperty;<br /><br />public class Change {<br />    @JsonProperty<br />    private Integer foo;<br />    @JsonProperty<br />    private Integer bar;<br />    @JsonProperty<br />    private Integer qix;<br />    @JsonProperty<br />    private Integer baz;<br /><br />    public Change(Change change) {<br />        if (change != null) {<br />            foo = change.foo;<br />            bar = change.bar;<br />            qix = change.qix;<br />            baz = change.baz;<br />        }<br />    }<br /><br />    public void pay(Coin coin) {<br />        switch (coin) {<br />            case FOO:<br />                foo = foo == null ? 1 : foo + 1;<br />                break;<br />            case BAR:<br />                bar = bar == null ? 1 : bar + 1;<br />                break;<br />            case QIX:<br />                qix = qix == null ? 1 : qix + 1;<br />                break;<br />            case BAZ:<br />                baz = baz == null ? 1 : baz + 1;<br />                break;<br />        }<br />    }<br />}<br /></pre> <pre class="brush:java"><br />import java.util.List;<br /><br />import static com.google.common.collect.Lists.newArrayList;<br /><br />public enum Coin {<br />    FOO(1),<br />    BAR(7),<br />    QIX(11),<br />    BAZ(21);<br /><br />    private int value;<br /><br />    Coin(int value) {<br />        this.value = value;<br />    }<br /><br />    public int getValue() {<br />        return value;<br />    }<br /><br />    public boolean canPay(int cents) {<br />        return cents >= value;<br />    }<br /><br />    private static class ListHolder {<br />        private static final List&lt;Coin&gt; valuesAsLists = newArrayList(values());<br />    }<br /><br />    public static List&lt;Coin&gt; valuesAsLists() {<br />        return ListHolder.valuesAsLists;<br />    }<br />}<br /></pre>La classe Change contient des annotations pour la sérialisation Json avec Jackson, elle contient également un constructeur par copie servant dans l'algo, ainsi qu'une méthode pay, permettant d'ajouter une pièce à une solution. Quand à la classe Coin, elle contient une méthode "canPay" permettant de savoir si on peut ajouter la pièce pour un nombre de cents restant. Les listes sont là pour pouvoir utiliser la méthode Collections2.filter de Guava. </p><p>Et pour finir, voici la classe principale : le service permettant de faire le calcul. <pre class="brush:java"><br />import com.google.common.base.Predicate;<br />import com.google.common.collect.Collections2;<br />import com.google.common.collect.Lists;<br /><br />import java.util.List;<br /><br />public enum ScalaskelChangeService {<br />    INSTANCE;<br /><br />    public static ScalaskelChangeService getInstance() {<br />        return INSTANCE;<br />    }<br /><br />    public List&lt;Change&gt; calculateChanges(int cents) {<br />        return completeChanges(cents, null, null);<br />    }<br /><br />    private List&lt;Change&gt; completeChanges(int cents, Change currentChange, Coin lastCoin) {<br />        // Stop condition of recursivity<br />        if (cents == 0) {<br />            return Lists.newArrayList(currentChange);<br />        }<br />        List&lt;Change&gt; changes = Lists.newArrayList();<br />        for (Coin coin : Collections2.filter(<br />                Coin.valuesAsLists(),<br />                new FilterCoins(lastCoin, cents))) {<br />            Change change = new Change(currentChange);<br />            change.pay(coin);<br />            changes.addAll(completeChanges(cents - coin.getValue(), change, coin));<br />        }<br />        return changes;<br />    }<br /><br />    /**<br />     * Filter coins with this rule :<br />     * coin is keeped only if :<br />     * &lt;ul&gt;<br />     * &lt;li&gt;its value is bigger or equals thant lastCoin&lt;/li&gt;<br />     * &lt;li&gt;we can pay with the coin.&lt;/li&gt;<br />     * &lt;/ul&gt;<br />     */<br />    private static class FilterCoins implements Predicate<Coin> {<br /><br />        private int minValue;<br />        private int centsToPay;<br /><br />        private FilterCoins(Coin lastCoin, int centsToPay) {<br />            minValue = lastCoin == null ? 0 : lastCoin.getValue();<br />            this.centsToPay = centsToPay;<br />        }<br /><br />        @Override<br />        public boolean apply(Coin input) {<br />            return minValue <= input.getValue() && input.canPay(centsToPay);<br />        }<br />    }<br />}<br /></pre>Cette classe est un enum pour le côté singleton. La classe FilterCoins permet de filtrer les pièces utilisables en fonction de la dernière pièce utilisée ainsi que le nombre de cents restant à payer. Pour l'algo, il s'agit d'un algo récursif relativement bourrin. Il est sûr que si les performances avaient été un critère, j'aurais sûrement modifié l'algo. J'espère que mon code est suffisamment clair pour ne pas avoir à l'expliquer d'avantage. </p><p>La dernière partie que nous n'avons pas vu est le "PathHandler" permettant de lier le service au WebServer : <pre class="brush:java"><br />import com.fasterxml.jackson.annotation.JsonInclude;<br />import com.fasterxml.jackson.core.JsonProcessingException;<br />import com.fasterxml.jackson.databind.ObjectMapper;<br />import fr.ybonnel.codestory.WebServerResponse;<br />import fr.ybonnel.codestory.path.scalaskel.Change;<br />import fr.ybonnel.codestory.path.scalaskel.ScalaskelChangeService;<br /><br />import javax.servlet.http.HttpServletRequest;<br />import javax.servlet.http.HttpServletResponse;<br />import java.util.List;<br /><br />public class ChangeScalaskelHandler extends AbstractPathHandler {<br /><br />    private ObjectMapper objectMapper = new ObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_NULL);<br /><br />    private boolean wrongParams(int centsToPay) {<br />        return centsToPay &lt;= 0 || centsToPay &gt; 100;<br />    }<br /><br />    @Override<br />    public WebServerResponse getResponse(HttpServletRequest request, String payLoad, String... params) throws JsonProcessingException {<br />        int centsToPay = Integer.parseInt(params[0]);<br />        if (wrongParams(centsToPay)) {<br />            return new WebServerResponse(HttpServletResponse.SC_FORBIDDEN, "Wrong parameters");<br />        }<br /><br />        List&lt;Change&gt; changes = ScalaskelChangeService.getInstance().calculateChanges(centsToPay);<br />        return new WebServerResponse(HttpServletResponse.SC_OK, objectMapper.writeValueAsString(changes));<br />    }<br />}<br /></pre>Dans cette classe, vous pouvez voir une petite protection afin d'éviter de faire tomber le serveur en demandant le change de 1.000.000 de cents. On peut également y voir la sérialisation Json avec Jackson, mais rien de sorcier non plus. </p><br/> <h1>La calculette</h1><p>Pour cet exercice, pas d'énoncé, la première requête reçue fut : "/?q=1+1" à laquelle on se doute qu'il faut répondre "2". Je ne vais pas vous détailler toutes les étapes par lesquelles je suis passé pour arriver au bout. Voici la liste des requêtes reçues (dans l'ordre) : <ul><li>1+1</li><li>2+2</li><li>3+3</li><li>4+4</li><li>5+5</li><li>6+6</li><li>7+7</li><li>8+8</li><li>9+9</li><li>1*1</li><li>2*2</li><li>3*3</li><li>4*4</li><li>5*5</li><li>6*6</li><li>7*7</li><li>8*8</li><li>9*9</li><li>1+2*2</li><li>(1+2)*2</li><li>(1+2+3+4+5+6+7+8+9+10)*2</li><li>(1+2)/2</li><li>((1+2)+3+4+(5+6+7)+(8+9+10)*3)/2*5</li><li>1,5*4</li><li>((1,1+2)+3,14+4+(5+6+7)+(8+9+10)*4267387833344334647677634)/2*553344300034334349999000</li><li>((1,1+2)+3,14+4+(5+6+7)+(8+9+10)*4267387833344334647677634)/2*553344300034334349999000/31878018903828899277492024491376690701584023926880</li><li>(-1)+(1)</li><li>1,0000000000000000000000000000000000000000000000001*1,0000000000000000000000000000000000000000000000001</li></ul>Cette liste vous permet sans doute de voir par quelles étapes je suis passé : <ul><li>Gestion des sommes</li><li>Gestion des multiplication</li><li>Gestion des priorités</li><li>Gestion des parenthèses</li><li>Gestion des divisions</li><li>Gestion des décimaux</li><li>Gestion des grands nombres</li><li>Gestion des nombres négatifs</li><li>Gestion des nombres de décimales élevés</li></ul>Pour la première version de mon code, j'ai tout fait à la main à grand coup de Pattern, voici le résultat final : <pre class="brush:java"><br />import com.google.common.base.Throwables;<br />import fr.ybonnel.codestory.query.calculate.Operator;<br />import fr.ybonnel.codestory.query.calculate.SearchParanthesis;<br /><br />import java.math.BigDecimal;<br />import java.math.RoundingMode;<br />import java.text.DecimalFormat;<br />import java.text.DecimalFormatSymbols;<br />import java.text.NumberFormat;<br />import java.text.ParseException;<br />import java.util.ArrayList;<br />import java.util.List;<br />import java.util.Locale;<br />import java.util.regex.Matcher;<br />import java.util.regex.Pattern;<br /><br />public class CalculateQueryHandler extends AbstractQueryHandler {<br /><br />    private static final String NOMBRE = "\\-?\\d+\\.?\\d*";<br />    private static final String PATTERN_DIVIDE = "(" + NOMBRE + ")/(" + NOMBRE + ")";<br />    private static final String PATTERN_MULTIPLY = "(" + NOMBRE + ")\\*(" + NOMBRE + ")";<br />    private static final String PATTERN_ADD = "(" + NOMBRE + ")\\+(" + NOMBRE + ")";<br /><br />    // operators list by priority.<br />    private List<Operator> operators = new ArrayList<Operator>() {{<br />        // operator divide.<br />        add(new Operator(PATTERN_DIVIDE) {<br />            @Override<br />            public BigDecimal operate(BigDecimal a, BigDecimal b) {<br />                try {<br />                    return a.divide(b);<br />                } catch (ArithmeticException exception) {<br />                    return a.divide(b, 1000, RoundingMode.HALF_UP);<br />                }<br />            }<br />        });<br />        // Operator Multiply.<br />        add(new Operator(PATTERN_MULTIPLY) {<br />            @Override<br />            public BigDecimal operate(BigDecimal a, BigDecimal b) {<br />                return a.multiply(b);<br />            }<br />        });<br />        // Operator Add.<br />        add(new Operator(PATTERN_ADD) {<br />            @Override<br />            public BigDecimal operate(BigDecimal a, BigDecimal b) {<br />                return a.add(b);<br />            }<br />        });<br />    }};<br /><br />    private Pattern patternParenthesis = Pattern.compile("\\((.*)\\)");<br />    private NumberFormat format = new DecimalFormat("#0.#", new DecimalFormatSymbols(Locale.FRANCE));<br /><br />    public CalculateQueryHandler() {<br />        format.setMaximumFractionDigits(500);<br />    }<br /><br />    @Override<br />    public String getResponse(String query) {<br />        String result = null;<br />        try {<br />            result = calculateWithParenthesis(query.replace(' ', '+').replace(',', '.'));<br />        } catch (ParseException e) {<br />            Throwables.propagate(e);<br />        }<br /><br />        try {<br />            BigDecimal retour = new BigDecimal(result);<br />            return format.format(retour);<br />        } catch (NumberFormatException numberFormatException) {<br />            numberFormatException.printStackTrace();<br />            return null;<br />        }<br />    }<br /><br />    private String calculateWithParenthesis(String calculateQuery) throws ParseException {<br />        Matcher matcherParenthsis = patternParenthesis.matcher(calculateQuery);<br /><br />        while (matcherParenthsis.find()) {<br />            SearchParanthesis searchParanthesis = new SearchParanthesis(calculateQuery).invoke();<br />            int start = searchParanthesis.getStart();<br />            int end = searchParanthesis.getEnd();<br /><br />            // Calculate the content of parenthesis.<br />            String queryBetweenParenthesis = calculateQuery.substring(start + 1, end - 1);<br />            String result = calculateWithoutParenthesis(queryBetweenParenthesis);<br /><br />            // Replace the parenthesis group with result.<br />            calculateQuery = calculateQuery.substring(0, start) + result + calculateQuery.substring(end);<br />            matcherParenthsis = patternParenthesis.matcher(calculateQuery);<br />        }<br /><br />        calculateQuery = calculateWithoutParenthesis(calculateQuery);<br />        return calculateQuery;<br />    }<br /><br />    private String calculateWithoutParenthesis(String calculateQuery) throws ParseException {<br /><br />        for (Operator operator : operators) {<br />            Matcher matcher = operator.matcher(calculateQuery);<br /><br />            while (matcher.find()) {<br />                BigDecimal a = new BigDecimal(matcher.group(1));<br />                BigDecimal b = new BigDecimal(matcher.group(2));<br />                BigDecimal result = operator.operate(a, b);<br /><br />                // Replace sur operation in string by result.<br />                calculateQuery = calculateQuery.substring(0, matcher.start()) + result.toString() + calculateQuery.substring(matcher.end());<br /><br />                matcher = operator.matcher(calculateQuery);<br />            }<br />        }<br /><br />        return calculateQuery;<br />    }<br />}<br /></pre>Je vous l'accorde, le code est relativement complexe, mais je suis assez fier d'avoir pondu une calculette à la main. </p><p>Devant tout ce code, j'ai décidé de simplifier tout ça grâce à groovy, vous allez voir le code est grandement simplifié : <pre class="brush:java"><br />import groovy.lang.GroovyShell;<br />import java.text.DecimalFormat;<br />import java.text.DecimalFormatSymbols;<br />import java.text.NumberFormat;<br />import java.util.Locale;<br /><br />public class CalculateQueryHandler extends AbstractQueryHandler {<br />    private NumberFormat format = new DecimalFormat("#0.#", new DecimalFormatSymbols(Locale.FRANCE));<br />    private GroovyShell shell = new GroovyShell();<br /><br />    public CalculateQueryHandler() {<br />        format.setMaximumFractionDigits(500);<br />    }<br /><br />    @Override<br />    public String getResponse(String query) {<br />        Object object = shell.evaluate("return " + query.replace(' ', '+').replace(',', '.'));<br />        return formatGroovyReturn(object);<br />    }<br /><br />    private String formatGroovyReturn(Object object) {<br />        try {<br />            return format.format(object);<br />        } catch (NumberFormatException numberFormatException) {<br />            numberFormatException.printStackTrace();<br />            return null;<br />        }<br />    }<br />}<br /></pre>Et voilà, merci groovy, finalement pas besoin de réinventer la roue... </p><br/><br/><br/><p>Cet article est le deuxième d'une série de trois articles dont le dernier est sans doute le plus intéressant : <a href="http://www.ybonnel.fr/2013/02/code-story-en-java-jajascript-et-les.html">Jajascript et les performance</a>. Afin de vous donner un avant-goût, vous pouvez regarder l'article sur le blog Code Story : <a href="http://code-story.net/2013/02/02/jajascript.html">Location d’astronef sur Jajascript</a>. </p>  
</p>
                <p><a href="2013/02/codestory-en-java-scalaskel-et-la.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2013/02/ma-participation-codestory-en-java-intro.html"><h1>Ma participation à CodeStory en java : Intro</h1></a>
                <p>03 février 2013</p>

                <p>Tags :
                <a href="CodeStory.html">CodeStory</a>, <a href="Java.html">Java</a>, <a href="TDD.html">TDD</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2013/02/ma-participation-codestory-en-java-intro.html" data-text="Ma participation à CodeStory en java : Intro" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2013/02/ma-participation-codestory-en-java-intro.html"></div>

                <p><p>La première étape du concours <a href="http://www.code-story.net/">Code Story</a> vient de se terminer, je vais donc tenter de faire un résumé de ma participation à ce concours. Pour les curieux, le classement est disponible <a href="https://www.blogger.com/status.code-story.net">ici</a>.<br />Etant sans doute un peu malade, j'ai participé à ce concours 3 fois : en Java, en Ceylon et en Scala. Mon inscription principale avec le code le plus soigné et complet reste celle en Java. Je vais donc dans un premier temps vous faire un retour sur la partie Java. L'ensemble du code source de ma participation en java est disponible sur <a href="https://github.com/ybonnel/CodeStory">github</a><br />Les étapes de l'application étant nombreuses, je vais découper ça en plusieurs articles  : <ul><li>Serveur Http et TDD (déjà présenté dans l'article suivant : <a href="http://www.ybonnel.fr/2013/01/marre-du-cloud-et-du-jee-vive-lauto.html">Marre du cloud et du JEE -&gt; vive l'auto-hébergement et les main.</a>)</li><li>Les logs et répondre à des questions fixes (dans le présent article)</li><li><a href="http://www.ybonnel.fr/2013/02/codestory-en-java-scalaskel-et-la.html">Scalaskel et la calculette</a></li><li><a href="http://www.ybonnel.fr/2013/02/code-story-en-java-jajascript-et-les.html">Jajascript et les performances</a></li></ul></p> <h1>Principes du concours</h1><p>Afin de comprendre les choix que j'ai faits au niveau du code, il est important de connaître les principes de ce concours. Au départ, on s'inscrit en donnant juste une URL publique (ex : http://serveur.mondomain.fr:8080). Le seul truc que l'on sait avant de commencer, c'est qu'on va recevoir une requête GET sur http://serveur.mondomain.fr:8080/?q=Quelle+est+ton+adresse+email à laquelle il faut répondre avec l'adresse email, pour les curieux, le règlement est disponible <a href="http://code-story.net/2013/01/04/concours-2013.html">ici</a>. On se doute également dès le départ qu'on recevra d'autres requêtes HTTP auxquelles il faudra répondre (d'où le besoin de logs).</p><br/> <h1>Répondre à des questions fixes</h1><p>Les premières requêtes n'étaient pas très compliquées, il s'agissait simplement de questions avec une réponse fixe attendue. Pour information, voici la liste des questions reçues : <ul><li>?q=Quelle est ton adresse email</li><li>?q=Es tu abonne a la mailing list(OUI/NON)</li><li>?q=Es tu heureux de participer(OUI/NON)</li><li>?q=Es tu pret a recevoir une enonce au format markdown par http post(OUI/NON)</li><li>?q=Est ce que tu reponds toujours oui(OUI/NON)</li><li>?q=As tu bien recu le premier enonce(OUI/NON)</li><li>?q=As tu bien recu le second enonce(OUI/NON)</li><li>?q=As tu passe une bonne nuit malgre les bugs de l etape precedente(PAS_TOP/BOF/QUELS_BUGS)</li><li>?q=As tu copie le code de ndeloof(OUI/NON/JE_SUIS_NICOLAS)</li><li>?q=Souhaites-tu-participer-a-la-suite-de-Code-Story(OUI/NON)</li></ul>Afin de pouvoir rapidement faire évoluer l'application pour ajouter la gestion de futures questions, voici comment j'ai développé.</p><p>Première étape le test JUnit (et oui j'ai fait du TDD), voici donc l'exemple du test pour la troisième question : <pre class="brush:java">@Test<br />public void should_answer_to_participate() throws Exception {<br />    WebConversation wc = new WebConversation();<br />    WebResponse response = wc.getResponse(getURL() + "/?q=Es tu heureux de participer(OUI/NON)");<br />    assertEquals(200, response.getResponseCode());<br />    assertEquals("Response must be 'OUI'", "OUI", response.getText());<br />}<br /></pre>Le test est donc très simple, rapide à écrire, et se met à la place du robot pour effectuer le test (la librairie utilisée est HttpUnit).</p><p>Voyons maintenant comment j'ai codé le serveur. A travers les premières questions, on se rend compte qu'une partie des requêtes reçues va l'être avec le paramètre "q", j'ai donc décidé de créer la notion de QueryHandler chargée de répondre aux requêtes reçues avec ce paramètre. Voici la classe abstraite associée : <pre class="brush:java">public abstract class AbstractQueryHandler {<br />    public abstract String getResponse(String query);<br />}<br /></pre></p><p>La tuyauterie pour appeler le handler (et le bon) et relativement simple. Côté handler HTTP, c'est juste la récupération du paramètre et l'appel d'une méthode de la classe chargée d'appeler le bon QueryHandler : <pre class="brush:java">String query = request.getParameter(QUERY_PARAMETER);<br />if (query != null) {<br />    response = QueryType.getResponse(query);<br />}<br /></pre>La variable "response" contient le texte à renvoyer, mais également le status HTTP à utiliser. La classe "QueryType" est en fait un "enum", prenant en paramètre de constructeur le handler à utiliser, et ayant une méthode abstraite "isThisQueryType" prenant en paramètre la "query" et renvoyant un boolean permettant de savoir si c'est lui qui est responsable de cette "query". Et pour finir, cet enum contient une méthode statique chargée d'appeler le bon QueryHandler en fonction de la query. Voici la classe avec l'exemple de question vu plus haut : <pre class="brush:java">import fr.ybonnel.codestory.WebServerResponse;<br />import javax.servlet.http.HttpServletResponse;<br /><br />public enum QueryType {<br /><br />    PARTICIAPATE(new FixResponseQueryHandler("OUI")) {<br />        @Override protected boolean isThisQueryType(String query) {<br />            return query.equals("Es tu heureux de participer(OUI/NON)");<br />        }<br />    };<br /><br />    private AbstractQueryHandler queryHandler;<br /><br />    QueryType(AbstractQueryHandler queryHandler) {<br />        this.queryHandler = queryHandler;<br />    }<br /><br />    protected abstract boolean isThisQueryType(String query);<br /><br />    public static WebServerResponse getResponse(String query) {<br />        for (QueryType oneQuestion : values()) {<br />            if (oneQuestion.isThisQueryType(query)) {<br />                return new WebServerResponse(HttpServletResponse.SC_OK, oneQuestion.queryHandler.getResponse(query));<br />            }<br />        }<br />        return new WebServerResponse(HttpServletResponse.SC_NOT_FOUND, "Query " + query + " is unknown");<br />    }<br />}<br /></pre>Vous pouvez donc voir dans cette enum l'apparition de la classe FixResponseQueryHandler, cette classe est très simple, son rôle est simplement de renvoyer une réponse fixe, la voici : <pre class="brush:java">public class FixResponseQueryHandler extends AbstractQueryHandler {<br /><br />    private String response;<br />    public FixResponseQueryHandler(String response) {<br />        this.response = response;<br />    }<br /><br />    @Override public String getResponse(String query) {<br />        return response;<br />    }<br />}<br /></pre></p><p>Voici donc tous les éléments que j'ai mis en place pour les questions avec réponses fixes. A posteriori, on aurait pu mettre en place une simple Map (c'est ce que j'ai fait en Ceylon et en Scala), mais c'est le problème de coder au fur et à mesure que les questions arrivent, on ne sait pas trop ce qui va arriver ensuite... J'aurais évidement pu refactorer tout ça (les tests unitaires me permettant d'être sûr de ne pas tout casser), mais j'ai eu la flemme, d'autant que ce n'est pas la partie la plus intéressante, les énoncés suivants étant bien plus sympas. </p><br/> <h1>Les logs</h1><p>Un élément important de ce concours, c'est que nous ne recevions aucune consigne par mail, twitter ou pigeon voyageur. Le seul mode d'interaction était l'envoi d'une requête HTTP par le robot qui renvoyait la requête tant qu'on ne répondait pas correctement. Afin de pouvoir être réactif aux nouvelles requêtes en toute circonstance, je me suis ajouté un système de logs en base de donnée avec possibilité de les récupérer par un appel http (ce qui me permettait de la faire même depuis mon téléphone). Je ne vais pas vous détailler comment j'ai mis en place ce système, mais plutôt comment j'ai mis en place la BDD tout en gardant un système simple et rapide à tester. </p> <h2>Mise en place de la BDD</h2><p>Comme vous le savez, je n'ai pas de stack compliquée pour cette application, pour mettre en place une BDD simple, je suis parti sur un h2 embarqué. Première étape ajout de la dépendance au pom.xml : <pre class="bursh:xml"><br />&lt;dependency&gt;<br />    &lt;groupId&gt;com.h2database&lt;/groupId&gt;<br />    &lt;artifactId&gt;h2&lt;/artifactId&gt;<br />    &lt;version&gt;1.3.170&lt;/version&gt;<br />&lt;/dependency&gt;<br /></pre></p><p>Sur l'utilisation de celle-ci, rien d'extra-ordinaire, je suis parti sur du jdbc à la main. Ça peux paraître archaïque, mais pour gérer 2 pauvres tables (une pour les logs et une pour les énoncés), pas besoin de sortir l'artillerie lourde. Pour les curieux, voici la classe centrale pour gérer la base : <pre class="brush:java"><br />import com.google.common.base.Throwables;<br />import org.h2.jdbcx.JdbcDataSource;<br /><br />import java.sql.Connection;<br />import java.sql.DriverManager;<br />import java.sql.SQLException;<br />import java.sql.Statement;<br /><br />public enum DatabaseManager {<br /><br />    INSTANCE;<br /><br />    public static final String TYPE_Q = "Q";<br />    public static final String DB_DRIVER = "org.h2.Driver";<br />    public static final String DB_USER = "sa";<br /><br />    private JdbcDataSource ds;<br /><br />    DatabaseManager() {<br />        try {<br />            Class.forName(DB_DRIVER);<br /><br />            boolean databaseExists = doesDatabaseExists();<br /><br />            ds = new JdbcDataSource();<br />            ds.setURL(DatabaseUtil.getUrl());<br />            ds.setUser(DB_USER);<br />            ds.setPassword(DB_USER);<br /><br />            if (!databaseExists) {<br />                createDatabase();<br />            }<br />        } catch (Exception exception) {<br />            Throwables.propagate(exception);<br />        }<br />    }<br /><br />    private static boolean doesDatabaseExists() {<br />        boolean databaseExists = false;<br />        try {<br />            String url = DatabaseUtil.getUrl() + ";IFEXISTS=TRUE";<br />            Connection connection = DriverManager.getConnection(url, DB_USER, DB_USER);<br />            connection.close();<br />            databaseExists = true;<br />        } catch (SQLException ignore) {<br />        }<br />        return databaseExists;<br />    }<br /><br />    public void createDatabase() throws SQLException {<br />        Connection conn = ds.getConnection();<br /><br />        Statement statementDrop = conn.createStatement();<br />        statementDrop.executeUpdate("DROP TABLE IF EXISTS LOG");<br /><br />        Statement statement = conn.createStatement();<br />        statement.executeUpdate("CREATE TABLE LOG (" +<br />                "HEURE TIMESTAMP," +<br />                "TYPE_LOG VARCHAR(10)," +<br />                "MESSAGE VARCHAR(500))");<br /><br />        statementDrop = conn.createStatement();<br />        statementDrop.executeUpdate("DROP TABLE IF EXISTS ENONCE");<br /><br />        statement = conn.createStatement();<br />        statement.executeUpdate("CREATE TABLE ENONCE (" +<br />                "ID INTEGER," +<br />                "TITLE VARCHAR(100)," +<br />                "ENONCE VARCHAR(4000))");<br /><br />        conn.close();<br />    }<br /><br />    private LogDao logDao;<br /><br />    public LogDao getLogDao() {<br />        if (logDao == null) {<br />            logDao = new LogDao(ds);<br />        }<br />        return logDao;<br />    }<br /><br />    private EnonceDao enonceDao;<br /><br />    public EnonceDao getEnonceDao() {<br />        if (enonceDao == null) {<br />            enonceDao = new EnonceDao(ds);<br />        }<br />        return enonceDao;<br />    }<br />}<br /></pre></p><p>Le but était de vous montrer que pour faire des trucs simples, il n'est pas toujours utile de sortir l'artillerie lourde avec du JPA ou autre... </p> <h2>Et pour les tests unitaires?</h2><p>Comme vous avez pu voir, les tests unitaires ne sont pas vraiment unitaire puisqu'ils testent l'application de bout en bout. Se pose du coup la question de la base de donnée qui ralentie les tests de manière inutile, heureusement h2 possède un mode mémoire qui rend la base très rapide et non persistante après les tests (ce qui permet de repartir à zéro à chaque fois). Pour passer d'un mode à l'autre, rien de sorcier : <pre class="brush:java">public static String getUrl() {<br />    if (test) {<br />        return "jdbc:h2:mem:codestory;DB_CLOSE_DELAY=-1";<br />    }<br />    return "jdbc:h2:./codestory";<br />}<br /></pre>Il ne faut pas oublier le "DB_CLOSE_DELAY=-1" qui permet de garder la base soit active tant que la jvm existe (ça évite d'avoir des problèmes de structures qui disparaissent d'un test à l'autre).</p><br /><br /><br /><p>À bientôt pour Scalaskel et la Calculette, puis pour le plus interessant : Jajascript et les performances.</p>
</p>
                <p><a href="2013/02/ma-participation-codestory-en-java-intro.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2013/01/marre-du-cloud-et-du-jee-vive-lauto.html"><h1>Marre du cloud et du JEE -> vive l'auto-hébergement et les main.</h1></a>
                <p>08 janvier 2013</p>

                <p>Tags :
                <a href="auto-hébergement.html">auto-hébergement</a>, <a href="cloud.html">cloud</a>, <a href="CodeStory.html">CodeStory</a>, <a href="git.html">git</a>, <a href="Java.html">Java</a>, <a href="JEE.html">JEE</a>, <a href="Jetty.html">Jetty</a>, <a href="NoMock.html">NoMock</a>, <a href="simple.html">simple</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2013/01/marre-du-cloud-et-du-jee-vive-lauto.html" data-text="Marre du cloud et du JEE -> vive l'auto-hébergement et les main." data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2013/01/marre-du-cloud-et-du-jee-vive-lauto.html"></div>

                <p> <p>Récemment l'équipe CodeStory a lancé le concours pour la sélection 2013, informations <a href="http://code-story.net/2013/01/04/concours-2013.html">ici</a>. </p> <p>Pour participer, il faut un serveur public qui répond à des requêtes HTTPs. Pour la première étape, il faut que le serveur réponde à la requête GET "http://foobar.com:9090/?q=Quelle+est+ton+adresse+email" avec votre adresse email.<br/>Rien de bien compliqué (en tout cas pour le moment), mais il faut évidement que votre serveur puisse évoluer pour répondre aux prochaines questions. </p><br/><br/> <h1>Architecture technique</h1> <p>Pour répondre au besoin de CodeStory, il y a plusieurs solutions (en restant dans l'univers java) : <ul><li>Du JEE (ou conteneur de servlet simple) hébergé chez cloudbees ou à la maison. </li><li>Du play hébergé chez heroku, cloudbees ou à la maison. </li><li>Du Google App Engine. </li><li>Ou beaucoup plus simple :) </il></ul>Dans le cadre de CodeStory, j'ai décidé de partir sur le beaucoup plus simple (assez largement inspiré par une présentation que David Gageot avait faîte au BreizhJUG en 2011, disponible sur <a href="http://www.parleys.com/#st=5&id=2959">parleys</a>). Je suis donc parti sur un jetty embarqué et démarré depuis un simple main. </p> <p>Pour mettre en place cette "architecture", deux étapes très compliquées : <ul><li>Le pom.xml</li><li>La classe main</li></ul></p><br/> <h2>Le pom.xml</h2><p>Il faut juste ajouter la dépendance vers Jetty : <pre class="brush: xml"><br />&lt;dependency&gt;<br />    &lt;groupId&gt;org.mortbay.jetty&lt;/groupId&gt;<br />    &lt;artifactId&gt;jetty&lt;/artifactId&gt;<br />    &lt;version&gt;6.1.25&lt;/version&gt;<br />&lt;/dependency&gt;<br /></pre></p><br/> <h2>La classe main</h2><p>Le boulot de la classe main est simplement de démarrer le serveur et traiter les requêtes HTTP : <pre class="brush: java"><br />package fr.ybonnel.codestory;<br /><br />import org.mortbay.jetty.Server;<br />import org.mortbay.jetty.handler.AbstractHandler;<br /><br />import javax.servlet.ServletException;<br />import javax.servlet.http.HttpServletRequest;<br />import javax.servlet.http.HttpServletResponse;<br />import java.io.IOException;<br /><br />public class WebServer extends AbstractHandler {<br /><br />    public static final String QUERY_PARAMETER = "q";<br /><br />    @Override<br />    public void handle(String target, <br />                       HttpServletRequest request, <br />                       HttpServletResponse httpResponse, <br />                       int dispatch)<br />            throws IOException, ServletException {<br />        // Traitement de la requète.<br />    }<br /><br />    public static void main(String[] args) throws Exception {<br />        int port = 10080;<br />        if (args.length == 1) {<br />            port = Integer.parseInt(args[0]);<br />        }<br />        Server server = new Server(port);<br />        server.setHandler(new WebServer());<br />        server.start();<br />        server.join();<br />    }<br />}<br /></pre></p><br/> <h2>Les intérêts</h2><p>L'intérêt d'une telle "architecture" est la simplicité, ce qui se traduit par trois avantages : <ul><li>Rapidité de démarrage : 38ms sur mon poste qui n'est pas un fourdre de guerre.</li><li>Tests unitaires sans mock : grâce à la rapidité de démarrage, on peux faire des tests qui démarrent le serveur, exécutent une requête GET, et arrêtent le serveur. On se place donc à la place du client, ce qui est sans doute une garantie d'avoir le résultat attendu.</li><li>Facilité d'installation : juste un jar à exécuter (donc très simple que ce soit dans l'IDE ou dans sur un serveur).</li></ul>  </p><br/><br/> <h1>Tests unitaires</h1><p>Comme on l'a vu, pour les tests unitaires, rien de bien sorcier : <ul><li>On démarre le serveur (dans une méthode @Before, pour qu'elle soit exécutée avant chaque test)</li><li>On fait le test (envoi d'une requête GET, et vérifications sur la réponse).</li><li>On arrête le serveur (dans une méthode @After).</li></ul></p><p>Code complet du test de la première étape : <pre class="brush: java"><br />package fr.ybonnel.codestory;<br /><br />import com.google.api.client.http.*;<br />import com.google.api.client.http.javanet.NetHttpTransport;<br />import org.junit.After;<br />import org.junit.Before;<br />import org.junit.Test;<br />import org.mortbay.jetty.Server;<br /><br />import java.io.BufferedReader;<br />import java.io.IOException;<br />import java.io.InputStreamReader;<br /><br />import static junit.framework.Assert.assertEquals;<br /><br />public class WebServerTest {<br /><br />    public static final int PORT = 18080;<br />    private Server server;<br /><br />    @Before<br />    public void setup() throws Exception {<br />        WebServer.setTest(true);<br />        server = new Server(PORT);<br />        server.setHandler(new WebServer());<br />        server.start();<br /><br />        new Thread(){<br />            @Override<br />            public void run() {<br />                try {<br />                    server.join();<br />                } catch (InterruptedException ignore) {<br />                }<br />            }<br />        }.start();<br />    }<br /><br />    @After<br />    public void teardown() throws Exception {<br />        server.stop();<br />    }<br /><br />    @Test<br />    public void should_answear_to_whatsyourmail() throws Exception {<br />        String url = "http://localhost:" + PORT + "/?q=Quelle+est+ton+adresse+email";<br />        HttpResponse response = sendGetRequest(url);<br />        assertEquals("Status code must be 200", 200, response.getStatusCode());<br />        assertEquals("Response must be my mail",<br />                "ybonnel@gmail.com",<br />                responseToString(response));<br />    }<br /><br />    private static final HttpTransport HTTP_TRANSPORT = new NetHttpTransport();<br /><br />    private HttpResponse sendGetRequest(String url) throws IOException {<br />        HttpRequestFactory requestFactory =<br />                HTTP_TRANSPORT.createRequestFactory();<br />        HttpRequest request = requestFactory.buildGetRequest(new GenericUrl(url));<br />        return request.execute();<br />    }<br /><br />    private String responseToString(HttpResponse response) throws IOException {<br />        BufferedReader bufReader = new BufferedReader(new InputStreamReader(<br />                response.getContent(), response.getContentCharset()));<br />        StringBuilder builder = new StringBuilder();<br />        String line = bufReader.readLine();<br />        while (line != null) {<br />            builder.append(line);<br />            line = bufReader.readLine()<br />        }<br />        return builder.toString();<br />    }<br />}<br /></pre>Pour les tests suivant, seule la méthode @Test est à réécrire.<br/>Pour faciliter l'écriture des requêtes http, j'utilise la librairie <a href="http://code.google.com/p/google-http-java-client/">google-http-client</a>, mais si vous avez mieux, je suis preneur.<br/>EDIT : j'utilise maintenant JWebUnit, beaucoup plus simple. </p><br/><br/> <h1>Déploiement</h1><p>Je n'ai pas encore parlé d'hébergement, ce qui pour un serveur qui doit être accessible publiquement reste important. </p><p>Ayant un serveur dédié à disposition, je suis parti sur de l'auto-hébergement. Si vous me demandez "pourquoi", je vous répondrai "parce que"...</p><p>Afin de m'auto-héberger j'ai suivi trois étapes : <ul><li>Assemblage du jar</li><li>Démarrage et arrêt</li><li>Déploiement simplifié</li></ul></p><br/> <h2>Assemblage du jar</h2><p>Mon build est sous maven, créer un jar contenant les dépendances n'est donc pas très compliqué, il suffit d'ajouter la configuration qui va bien dans le pom.xml : <pre class="brush: xml"><br />&lt;build&gt;<br />    &lt;plugins&gt;<br />        &lt;plugin&gt;<br />            &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;<br />            &lt;configuration&gt;<br />                &lt;archive&gt;<br />                    &lt;manifest&gt;<br />                        &lt;mainClass&gt;fr.ybonnel.codestory.WebServer&lt;/mainClass&gt;<br />                    &lt;/manifest&gt;<br />                &lt;/archive&gt;<br />                &lt;finalName&gt;${artifactId}&lt;/finalName&gt;<br />                &lt;appendAssemblyId&gt;false&lt;/appendAssemblyId&gt;<br />                &lt;descriptorRefs&gt;<br />                    &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;<br />                &lt;/descriptorRefs&gt;<br />            &lt;/configuration&gt;<br />        &lt;/plugin&gt;<br />    &lt;/plugins&gt;<br />&lt;/build&gt;<br /></pre></p><br/> <h2>Scripts de démarrage et d'arrêt</h2><p>Pour le démarrage et l'arrêt, je ne me suis pas cassé la tête : <ul><li>Démarrage : <pre class="brush: shell">java -jar code-story.jar &gt;&gt; serveur.log 2&gt;&1 &</pre></li><li>Arrêt : <pre class="brush: shell">ps -ef | grep java | grep code-story | grep -v grep | while read a b c <br />do<br />    kill -9 $b<br />done</pre></li></ul></p><br/> <h2>Déploiement simplifié</h2><p>Le dernier truc auquel je tenais est un déploiement simple, je suis passé par deux étapes avec des logiques très différentes : <ul><li>Déploiement par update des sources</li><li>Déploiement par git push</li></ul></p> <h4>Déploiement par update des sources</h4><p>Ma première façon de déployer était relativement simple, j'ai fait un clone de mon repo git sur le serveur. Donc pour redéployer, je faisait simplement un "git pull", suivi d'une compilation et restart du serveur.<br/>Mon script de déploiement ressemblait donc à : <pre class="brush: shell"><br />git pull<br />mvn clean install assembly:single<br /></pre>Il suffisait ensuite de redémarrer le serveur pour prendre en compte le nouveau jar. </p><p>Quelques inconvénients cependant à cette technique : <ul><li>Il faut se connecter au serveur pour le mettre à jour.</li><li>On mélange les sources et la partie serveur au même endroit</li></ul></p> <h4>Déploiement par git push</h4><p>J'ai eu envie que le déploiement se résume à un "git push serveur master" depuis mon poste de dev (fortement inspiré de la façon de déployer sur heroku).</p><p><u>Première étape</u>, créer le repo git sur le serveur (depuis le serveur) : <pre class="brush: shell"><br />mkdir CodeStory.git<br />cd CodeStory.git<br />git init --bare<br /></pre>Et voilà, j'ai un repo git accessible par ssh.</p><p><u>Deuxième étape</u>, pousser le contenu actuel sur le repo (depuis mon poste de dev) : <pre class="brush: shell"><br />git remote add serveur ssh://ybonnel@XXX.XXX.XXX.XXX:XXXX/home/ybonnel/CodeStory.git<br />git push serveur master<br /></pre></p><p><u>Troisième étape</u>, créer la partie serveur (sur le serveur donc) : <pre class="brush: shell"><br />mkdir CodeStory-server<br />cd CodeStory-server/<br />cp ../CodeStory/target/code-story.jar .<br />cp ../CodeStory/scripts/* .<br /></pre>Mon répertoire "CodeStory-server" contient donc : <ul><li>Le jar</li><li>Le script de démarrage et le script d'arrêt</li></ul></p><p><u>Quatrième et dernière étape</u>, créer le hook sur le repo git. Pour ce faire, j'ai créé le script "post-receive" dans "CodeStory.git/hooks" dont voici le contenu : <pre class="brush: shell"><br />echo "Updating server..."<br />rm -rf /home/ybonnel/CodeStory<br />git clone /home/ybonnel/CodeStory.git /home/ybonnel/CodeStory<br />cd /home/ybonnel/CodeStory<br />./updateServeur.sh<br />echo "Update and restart of server are done"<br /></pre>Et voici le contenu du script "updateServeur.sh" : <pre class="brush: shell"><br />mvn clean install assembly:single<br />if [ $? -eq 0 ]<br />then<br />        cp scripts/* ../CodeStory-server/<br />        cp target/code-story.jar ../CodeStory-server/code-story.jar.new<br />        cd ../CodeStory-server<br />        ./stopServeur.sh<br />        mv code-story.jar code-story.jar.old<br />        mv code-story.jar.new code-story.jar<br />        ./startServeur.sh<br />        sleep 1<br />        tail -10 serveur.log<br />fi<br /></pre>Un fois ce hook mis en place, lorsque je fait un "git push serveur master" depuis mon poste de dev, une compile maven se lance, et si le build maven est OK, le serveur est mis à jour. Et je vois le résultat de la compile et du déploiement en direct lors de mon git push. </p><br/><br/> <h1>Et dans la vrai vie?</h1><p>Maintenant vous allez me dire, c'est bien sympa ton truc, mais dans la vrai vie, les projets sont un peu plus compliqués que simplement fournir un email en réponse à un GET...<br/>Les architectures Web modernes sont souvent composées d'une partie serveur qui répond du JSON, et une partie cliente qui joue avec (y a qu'à voir le succès de angular.js). Et avec des architectures de ce type, répondre du JSON est-il beaucoup plus compliqué que répondre une adresse email? </p><p>Pour information, mon site <a href="http://ybo-tv.ybonnel.fr">ybo-tv</a> est hébergé sur un tomcat, mais il serait relativement facile de le basculer sur une architecture de ce type (pas de stack lourde juste pour répondre du JSON, c'est facilement faisable en spécifique). </p>
</p>
                <p><a href="2013/01/marre-du-cloud-et-du-jee-vive-lauto.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2012/08/comparaison-des-parseurs-csv.html"><h1>Comparaison des parseurs CSV</h1></a>
                <p>23 août 2012</p>

                <p>Tags :
                <a href="Comparatif.html">Comparatif</a>, <a href="CSV.html">CSV</a>, <a href="CsvEngine.html">CsvEngine</a>, <a href="Java.html">Java</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2012/08/comparaison-des-parseurs-csv.html" data-text="Comparaison des parseurs CSV" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2012/08/comparaison-des-parseurs-csv.html"></div>

                <p>Mon petit projet "CsvEgine" commençant à ressembler à quelque chose, je vais me lancer dans un petit comparatifs des parseurs que je peux trouver sur internet.<br /><br />Pour pouvoir comparer ces différents parseurs je vais utiliser l'exemple basique de l'utilisation de CsvEngine : <a href="https://github.com/ybonnel/CsvEngine/wiki/Basics">Basics</a>.<br/>Il s'agit donc de parser un fichier CSV contenant des chiens avec comme attributs le nom, la race et le propriétaire.<br/>On verra également comment écrire le fichier. <br/>La troisième étape de comparaison sera la validation : <ul><li>Le nom et la race sont obligatoires</li><li>La race doit faire partie d'une liste connues de races</li></ul><br/>La quatrième étape sera du parsing CSV complexe, ajout de retour à la ligne pour le propriétaire. <br/><br/>Et enfin pour finir la comparaison je finirai avec un petit bench, en reprenant ce que j'avais fait mon "CsvEngine" (qui à l'époque s'appelait MoteurCsv) : <a href="http://www.ybonnel.fr/2012/02/bench-de-moteurcsv.html">Bench MoteurCsv</a><br/><br/>Pour la liste des parseurs, je suis parti de cet article : <a href="http://www.improve-technologies.com/2012/07/18/java-et-csv-tour-dhorizon-des-solutions-open-source/">Java et CSV tour d'horizon des solutions open-source</a><br/>Je rajouterai quand même CsvEngine :) <br/><br/>Comme d'habitude, l'ensemble du code est disponible sur github : <a href="https://github.com/ybonnel/CsvJavaComparaison">CsvJavaComparaison</a>. <br/><br/> <h1>BeanFiles</h1> Site : <a href="http://code.google.com/p/beanfiles/">http://code.google.com/p/beanfiles/</a><br/><br/> <h2>Étape 0 : Documentation et mise en place</h2>Voici tout d'abord les problèmes que j'ai rencontré avec BeanFiles pour la mise en place : <ul><li>La documentation est très pauvre : une page sur le wiki, plus une classe de test.</li><li>BeanFiles est une librairie construite avec maven, mais je n'ai pas trouvé de repo maven associé, ce qui a compliqué la mise en place</li><li>La documentation est relativement pauvre, elle ne contient qu'un exemple de code, mais pas de tuto de mise en place, du coup j'ai été obligé d'aller voir dans le pom.xml du code source pour avoir les dépendances.</li></ul> <br/><br/> <h2>Étape 1 : Lecture du fichier CSV simple</h2>La mise en place est relativement simple une fois que les problèmes ont été résolus :). <br/>Mise à part les problèmes sités plus haut, BeanFiles n'aime pas du tout avoir des lignes vides à la fin du fichier.<br/>Une autre limitation, les attributs de la classe doivent avoir les mêmes noms que les entêtes dans le fichier CSV.  <br/><br/> La lecture est relativement simple : <pre class="brush: java">public List&lt;Dog&gt; getDogs(InputStream stream) throws IOException {<br />    CSVReaderIterator&lt;Dog&gt; readerIterator = new CSVReaderIterator&lt;Dog&gt;(Dog.class, stream);<br />    stream.close();<br />    List&lt;Dog&gt; dogs = new ArrayList&lt;Dog&gt;();<br />    for (Dog dog : readerIterator) {<br />        dogs.add(dog);<br />    }<br />    return dogs;<br />}</pre>J'aurais préféré que la fermeture du stream soit gérée par la librairie.<br/>L'utilisation d'un iterator est pas bête, toutefois elle peux donner l'impression que la lecture du fichier se fait au fur et à mesure, alors que pas du tout :)<br/>Du coup comme la lecture est finie après l'appel au constructeur, j'aurais bien aimé pouvoir récupérer directement la liste (un getAll() sur l'iterator).<br/>Je trouve qu'avoir mis le parsing dans le constructeur n'est pas génial...<br/><br/> <h2>Étape 2 : écriture de fichier CSV</h2>Il n'est pas possible d'écrire avec cette librairie.<br/><br/> <h2>Étape 3 : validation</h2>Pas de validation non plus.<br/><br/> <h2>Étape 4 : parsing complexe.</h2>Aucun problème avec les retour à la ligne pour BeanFiles.<br/><br/> <h2>Étape 5 : bench</h2>Pour le bench, j'ai généré un fichier "moyen" (100 000 lignes) et un gros fichier (1 000 000 lignes).<br/>Pour le fichier moyen, le temps moyen de traitement est de 1292ms.<br/><br/> Pour le gros fichier, il a fallu que je monte la JVM à 2Go. C'est un problème que je vois à BeanFiles, il n'y a pas de possibilité d'ajouter un handler pour effectuer un traitement au fur et à mesure de la lecture. Pour traiter de gros fichiers, c'est donc un gros problème.<br/>Pour traiter ce fichier, le temps moyen de traitement est de 15120ms avec une consommation mémoire d'un peu moins de 1,6Go.<br/><br/> <h1>BeanIO</h1>BeanIO est sûrement très bien, mais j'aime pas trop les configuration XML, donc je passe.<br/><br/>  <h1>Commons-Csv</h1>Je ne l'ai pas étudié non plus, pour deux raisons : <ul><li>La version actuelle est la version 1.0-SNAPSHOT</li><li>C'est bas niveau, un peu comme open-csv</li></ul><br/><br/> <h1>CsvToSql</h1>Encore du XML... et en plus, ça n'a pas l'air adapté à ce que je veux faire.<br/><br/> <h1>FlatPack</h1>Encore du XML...<br/><br/> <h1>JavaCSV</h1>Les exemples de code montre que cette librairie ne fait pas vraiment du mapping : <a href="http://www.csvreader.com/java_csv_samples.php">JavaCSV Samples</a><br/><br/> <h1>JCsv</h1> Site : <a href="http://code.google.com/p/jcsv/">http://code.google.com/p/jcsv/</a><br/><br/> <h2>Étape 0 : Documentation et mise en place</h2>La mise en place est très simple et documentée, juste la dépendance à ajouter et c'est parti.<br/>C'est le gros point positif pour cette librairie la documentation est très riche.<br/><br/> <h2>Étape 1 : Lecture du fichier CSV simple</h2>Étant fan du principe des annotations, je choisi d'utiliser cette méthode pour mon parsing : <pre class="brush: java">public class Dog {<br />    @MapToColumn( column = 0)<br />    private String name;<br />    @MapToColumn( column = 1)<br />    private String race;<br />    @MapToColumn( column = 2)<br />    private String proprietary;<br />}</pre>J'aurais préféré pouvoir utiliser la ligne d'entête mais bon... <br/><br/>La lecture n'est pas très compliquée non plus : <pre class="brush: java">public List&lt;Dog&gt; getDogs(InputStream stream) throws IOException {<br />    Reader reader = new InputStreamReader(stream);<br /><br />    ValueProcessorProvider provider = new ValueProcessorProvider();<br />    CSVEntryParser&lt;Dog&gt; entryParser = new AnnotationEntryParser&lt;Dog&gt;(Dog.class, provider);<br />    CSVReader&lt;Dog&gt; csvDogReader = new CSVReaderBuilder&lt;Dog&gt;(reader)<br />            .entryParser(entryParser)<br />            .strategy(new CSVStrategy(',', '"', '#', true, true)).build();<br /><br />    return csvDogReader.readAll();<br />}</pre>Lors de mon premier essai, je n'avais pas mis de "strategy", et l'exception remontée n'était pas très parlante (ArrayIndexOutBoundException)... Mis à part ça, je n'ai pas eu de d'autres problèmes.<br/><br/> <h2>Étape 2 : écriture de fichier CSV</h2>L'écriture n'est pas très compliquée, par contre on ne peut pas utiliser les annotations, ce qui est un peu dommage. <pre class="brush: java">public void writeFile(List&lt;Dog&gt; dogs, File file) throws IOException {<br /><br />    CSVEntryConverter&lt;Dog&gt; entryConverter = new CSVEntryConverter&lt;Dog&gt;() {<br />        @Override<br />        public String[] convertEntry(Dog dog) {<br />            String[] columns = new String[3];<br />            columns[0] = dog.getName();<br />            columns[1] = dog.getRace();<br />            columns[2] = dog.getProprietary();<br /><br />            return columns;<br />        }<br />    };<br />    CSVWriter&lt;Dog&gt; csvDogWriter = new CSVWriterBuilder&lt;Dog&gt;(new FileWriter(file))<br />            .entryConverter(entryConverter)<br />            .strategy(new CSVStrategy(',', '"', '#', true, true))<br />            .build();<br />    csvDogWriter.writeAll(dogs);<br />    csvDogWriter.close();<br />}<br /></pre> Le résultat n'est pas très bon, si les champs contiennent des retours à la ligne, il n'ajoute pas les caractères '"' avant et après. Il n'ajoute pas l'entête.<br/>Bref, l'écriture existe, mais elle n'est pas satisfaisante de mon point de vue.<br/><br/> <h2>Étape 3 : validation</h2>Pas de principe de validation.<br/><br/> <h2>Étape 4 : parsing complexe.</h2>Aucun problème avec les retours à la ligne pour JCsv.<br/><br/> <h2>Étape 5 : bench</h2>J'utilise les mêmes fichiers que pour BeanFiles.<br/>Pour le fichier moyen, le temps moyen de traitement est de 39 219ms.<br/><br/>Pas de problème de consommation mémoire, JCsv permet de lire ligne par ligne, on a donc pas besoin de tout stocker dans une liste. Par contre les performances sont très mauvaises, cela provient du fait que JCsv appelle getAnnotations pour chaque ligne, et ne met rien en cache. <br/><br/>Le gros fichier confirme le bench avec le fichier moyen : <ul><li>Temps de traitement moyen : 367 449ms</li></ul><br/><br/> <h1>JSefa</h1> Site : <a href="http://jsefa.sourceforge.net/">http://jsefa.sourceforge.net/</a><br/><br/> <h2>Étape 0 : Documentation et mise en place</h2>La mise en place n'est pas documentée et il n'existe pas de repo maven (en tout cas je l'ai pas trouvé), par contre il suffit d'ajouter le jar.<br/>Au niveau documentation, il existe une page avec les exemples basiques, pour des trucs plus complexes, il faut regarder la javadoc ou le code source.<br/><br/> <h2>Étape 1 : Lecture du fichier CSV simple</h2>La déclaration du mapping via les annotations est plutôt simple : <pre class="brush: java">@CsvDataType<br />public class Dog {<br />    @CsvField(pos = 0)<br />    private String name;<br />    @CsvField(pos = 1)<br />    private String race;<br />    @CsvField(pos = 2)<br />    private String proprietary;<br />}</pre>J'aurais préféré pouvoir utiliser la ligne d'entête mais bon...<br/><br/>La lecture n'est pas très compliquée non plus : <pre class="brush: java">public List&lt;Dog&gt; getDogs(InputStream stream) throws IOException {<br />    CsvConfiguration config = new CsvConfiguration();<br />    config.setFieldDelimiter(',');<br />    Deserializer deserializer = CsvIOFactory.createFactory(config, Dog.class).createDeserializer();<br /><br />    List&lt;Dog&gt; dogs = new ArrayList&lt;Dog&gt;();<br /><br />    deserializer.open(new InputStreamReader(stream));<br />    while (deserializer.hasNext()) {<br />        dogs.add(deserializer.&lt;Dog&gt;next());<br />    }<br />    deserializer.close(true);<br /><br />    return dogs;<br />}</pre>Pour filtrer l'entête on est obligé d'ajouter un Filter, un simple boolean dans les config aurait été appréciable...<br/><br/><h2>Étape 2 : écriture de fichier CSV</h2>L'écriture n'est pas très compliquée non plus : <pre class="brush: java">public void writeFile(List&lt;Dog&gt; dogs, File file) throws IOException {<br />    CsvConfiguration config = new CsvConfiguration();<br />    config.setFieldDelimiter(',');<br />    Serializer serializer = CsvIOFactory.createFactory(config, Dog.class).createSerializer();<br /><br />    serializer.open(new FileWriter(file));<br />    for (Dog dog : dogs) {<br />        serializer.write(dog);<br />    }<br />    serializer.close(true);<br />}<br /></pre>Toujours pas moyen d'ajouter l'entête.<br/><br/> <h2>Étape 3 : validation</h2>Il existe une couche de validation, par contre elle n'est pas documentée, et je n'ai pas réussi à la faire fonctionner (n'hésitez pas à corriger mon code sur github si vous savez comment faire :) ).<br/><br/> <h2>Étape 4 : parsing complexe.</h2>Aucun problème avec les retour à la ligne pour JSefa.<br/><br/> <h2>Étape 5 : bench</h2>J'utilise les mêmes fichiers que pour BeanFiles.<br/>Pour le fichier moyen, le temps moyen de traitement est de 791ms.<br/><br/>Le gros fichier confirme le bench avec le fichier moyen : <ul><li>Temps de traitement moyen : 7 652ms</li></ul><br/><br/> <h1>open-csv</h1>C'est une librairie bas niveau (utilisée par la plupart des parseurs haut niveaux), je l'étudierai donc pas ici.<br/><br/> <h1>Ostermiller CSV</h1>Dans cette librairie, le mapping se fait à la main, je ne l'étudierai donc pas.<br/><br/> <h1>Skife CSV</h1>Encore une librairie bas niveau.<br/><br/> <h1>Super CSV</h1> Site : <a href="http://supercsv.sourceforge.net/">http://supercsv.sourceforge.net/</a><br/><br/> <h2>Étape 0 : Documentation et mise en place</h2>La mise en place n'est pas documentée, c'est pas du maven, dont pas si simple que ça, faut bien penser à mettre les deux jar dans les dépendances...<br/>De manière générale la documentation est plutôt pas mal (malgré le fait qu'il n'existe pas de documentation pour la mise en place).<br/><br/> <h2>Étape 1 : Lecture du fichier CSV simple</h2>Pas d'annotation pour cette librairie, tout se fait par le nom des attributs.<br/>Pour les options il faut passer par des CellProcessors, j'y reviendrai pour la validation.<br/><br/>La lecture n'est pas très compliquée : <pre class="brush: java"><br />public List&lt;Dog&gt; getDogs(InputStream stream) throws IOException {<br />    List&lt;Dog&gt; dogs = new ArrayList&lt;Dog&gt;();<br /><br />    ICsvBeanReader inFile = new CsvBeanReader(new InputStreamReader(stream), CsvPreference.STANDARD_PREFERENCE);<br />    final String[] header = inFile.getCSVHeader(true);<br />    Dog dog;<br />    while( (dog = inFile.read(Dog.class, header)) != null) {<br />        dogs.add(dog);<br />    }<br />    inFile.close();<br />    return dogs;<br />}</pre>La gestion de l'entête et l'itération se fait à la main, je trouve ça dommage. Pour le reste c'est plutôt efficace.<br/><br/><h2>Étape 2 : écriture de fichier CSV</h2>Pour l'écriture, il n'y a pas de gestion de mapping, tout ce fait à la main, du coup je ne l'étudierai pas ici.<br/><br/> <h2>Étape 3 : validation</h2>Pour la validation, c'est plutôt efficace, par contre cela repose sur l'ordre des champs, un peu dommage.<br/>Il faut donc déclarer un tableau de CellProcessor : <pre class="brush: java">public static final CellProcessor[] userProcessors = new CellProcessor[] {<br />        new NotNull(),<br />        new IsIncludedIn(new HashSet&lt;Object&gt;(DogValid.POSSIBLE_RACES)),<br />        null<br />};</pre>On passe ensuite ce tableau pour le parsing des lignes : <pre class="brush: java">inFile.read(DogValid.class, header, userProcessors)</pre><br/><br/><h2>Étape 4 : parsing complexe.</h2>Aucun problème avec les retours à la ligne pour Super Csv.<br/><br/> <h2>Étape 5 : bench</h2>J'utilise les mêmes fichiers que pour BeanFiles.<br/>Pour le fichier moyen, le temps moyen de traitement est de 749ms.<br/><br/>Le gros fichier confirme le bench avec le fichier moyen : <ul><li>Temps de traitement moyen : 7 523ms</li></ul><br/><br/> <h1>CsvEngine</h1> Pour ceux qui ne le savent pas, je suis le développeur de cette librairie, je ne suis donc sans doute pas très objectif :).<br/>Site : <a href="https://github.com/ybonnel/CsvEngine">https://github.com/ybonnel/CsvEngine</a><br/><br/> <h2>Étape 0 : Documentation et mise en place</h2>La mise en place est très simple et documentée : <a href="https://github.com/ybonnel/CsvEngine/wiki/Install">Wiki install</a>.<br/>De manière générale, entre le wiki, la javadoc et les tests, je pense objectivement que CsvEngine est la librairie la plus documentée de celles que j'ai testées.<br/><br/>   <h2>Étape 1 : Lecture du fichier CSV simple</h2>Il faut tout d'abord ajouter les annotations à la classe dog : <pre class="brush: java">@CsvDataType<br />@CsvFile<br />public class Dog {<br />    @CsvColumn("name")<br />    private String name;<br />    @CsvColumn("race")<br />    private String race;<br />    @CsvColumn("proprietary")<br />    private String proprietary;<br />}</pre>Un truc qu'il faudra ajouter dans CsvEngine et le fait de rendre le nom du champs CSV facultatif (déduit du nom de l'attribut).<br/><br/>La lecture est très simple : <pre class="brush: java"><br />public List&lt;Dog&gt; getDogs(InputStream stream) throws IOException, CsvErrorsExceededException {<br />    CsvEngine engine = new CsvEngine(Dog.class);<br />    return engine.parseInputStream(stream, Dog.class).getObjects();<br />}</pre><br/><br/> <h2>Étape 2 : écriture de fichier CSV</h2>L'écriture n'est pas plus compliquée que la lecture : <pre class="brush: java">public void writeFile(List&lt;Dog&gt; dogs, File file) throws IOException {<br />    CsvEngine engine = new CsvEngine(Dog.class);<br />    engine.writeFile(new FileWriter(file), dogs, Dog.class);<br />}</pre><br/><br/> <h2>Étape 3 : validation</h2>Pour la validation tout passe par les annotations : <pre class="brush: java">@CsvFile<br />public class DogValid {<br />    @CsvColumn(value = "name", mandatory = true)<br />    private String name;<br />    @CsvValidation(ValidatorRace.class)<br />    @CsvColumn(value = "race", mandatory = true)<br />    private String race;<br />    @CsvColumn("proprietary")<br />    private String proprietary;<br />    <br />    public static class ValidatorRace extends ValidatorCsv {<br />        @Override<br />        public void validate(String field) throws ValidateException {<br />            if (!POSSIBLE_RACES.contains(field)) {<br />                throw new ValidateException("The race \"" + field + "\" isn't correct");<br />            }<br />        }<br />    }<br />}<br /></pre> On lit ensuite la fichier comme d'habitude : <pre class="brush: java">public List&lt;DogValid&gt; readDogsValid(InputStream stream) throws CsvErrorsExceededException {<br />   CsvEngine engine = new CsvEngine(DogValid.class);<br />   return engine.parseInputStream(stream, DogValid.class).getObjects();<br />}</pre><br/><br/> <h2>Étape 4 : parsing complexe.</h2>Aucun problème avec les retour à la ligne pour CsvEngine.  <h2>Étape 5 : bench</h2>J'utilise les mêmes fichiers que pour BeanFiles. Pour le fichier moyen, le temps moyen de traitement est de 693ms.<br/><br/>Le gros fichier confirme le bench avec le fichier moyen : <ul><li>Temps de traitement moyen : 7 028ms</li></ul><br/><br/> <h1>Conclusion</h1> Première conclusion, écrire un article aussi long avec l'éditeur de Blogger est une corvée... faut que je trouve autre chose pour mon blog.<br/><br>Voici un petit tableau récapitulatif des tests que j'ai pu mené sur ces librairies :  <table border="1" style="text-align:center"><tr><th/><th>Documentation</th><th>Mise en place</th><th>Lecture</th><th>Écriture</th><th>Validation</th><th>Temps de traitement</th></tr><tr><td><a href="http://code.google.com/p/beanfiles">BeanFiles</a></td><td>-</td><td>-</td><td>=</td><td>X</td><td>X</td><td>15 120</td></tr><tr><td><a href="http://code.google.com/p/jcsv">JCsv</a></td><td>+</td><td>+</td><td>-</td><td>-</td><td>X</td><td>367 449</td></tr><tr><td><a href="http://jsefa.sourceforge.net">JSefa</a></td><td>-</td><td>=</td><td>-</td><td>=</td><td>-</td><td>7 652</td></tr><tr><td><a href="http://supercsv.sourceforge.net">Super CSV</a></td><td>+</td><td>=</td><td>+</td><td>-</td><td>+</td><td>7 523</td></tr><tr><td><a href="https://github.com/ybonnel/CsvEngine">CsvEngine</a></td><td>+</td><td>+</td><td>+</td><td>+</td><td>+</td><td>7 028</td></tr></table> Légende : <ul><li>X : N'existe pas</li><li>- : Existe mais pas terrible</li><li>= : Existe et marche plutôt bien</li><li>+ : Existe et est vraiment bien fait :)</li></ul> De mon point de vue tout à fait objectif CsvEngine est la meilleure librairie sur tout les points, son seul défaut est sans doute mon Anglais très approximatif.
</p>
                <p><a href="2012/08/comparaison-des-parseurs-csv.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2012/05/retour-de-devoxx-france-troisieme.html"><h1>Retour de Devoxx France : troisième journée</h1></a>
                <p>08 mai 2012</p>

                <p>Tags :
                <a href="Devoxx.html">Devoxx</a>, <a href="Java.html">Java</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2012/05/retour-de-devoxx-france-troisieme.html" data-text="Retour de Devoxx France : troisième journée" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2012/05/retour-de-devoxx-france-troisieme.html"></div>

                <p>Après mon retour sur la première journée (<a href="http://www.ybonnel.fr/2012/04/retour-de-devoxx-france-premiere.html">ici</a>) et la deuxième journée (<a href="http://www.ybonnel.fr/2012/05/retour-de-devoxx-france-deuxieme.html">ici</a>), voici celui de la troisième et dernière journée. <br/><br/><h1>Les keynotes</h1>Après avoir avalé un nombre de cafés important (la fatigue commençant à se faire sentir), je me dirige vers la salle des keynotes. La salle est toujours aussi impressionnante (950 places).<br/><br/><h2>Trends in mobile application development</h2>Je vais pas pouvoir vraiment vous parler de cette keynote, elle était réalisée par IBM, et tout le monde s'endormait...<br/>La keynote était tellement intéressante que tout le monde se lâchait sur twitter. La seule chose marrante de cette conf a été la fin, où Nicolas Martignole nous a dit que le tweet wall était en panne et qu'il ne pouvait pas l'afficher, belle manière de ne pas mettre mal à l'aise un des sponsors de Devoxx :). <br/><br/><h2>Portrait du développeur en "The Artist"</h2>Rien à voir avec la conf précédente, c'est plutôt l'inverse...<br/>  Patrick Chanezon nous livre son portrait de la vie classique d'un développeur, passionnant. Je ne peux que vous conseiller d'aller voir les slides sur <a href="http://www.slideshare.net/chanezon/devoxx-france-2012-portrait-du-developeur-en-the-artist">slide-share</a>.<br/>Le sujet principale était le cloud, mais cette conf allait beaucoup plus loin et j'ai adoré.<br/><br/><h2>Abstraction Distractions for France</h2>Neal Ford nous parle de couches abstractions, je pense que c'est une des conf les plus impressionnante que j'ai vu, Neal est un très bon orateur et la conf est très bien préparée. Ça ressemblait à une key-note Apple :). <br/><br/><h1>Kotlin ou CodeStory?</h1>Finnalement je suis retourné à CodeStory, si vous ne savez pas ce que c'est, aller voir mon billet sur la deuxième journée :).<br/>Toujours aussi intéressant, cette fois j'ai ramener mon Ordi, j'ai donc même forké et mis en place l'environnement de dev, mais le temps d'installer ZombyJS, j'ai pas pu aller beaucoup plus loin (il fallait installer Node.js...).<br/>Kotlin est lui un nouveau langage créé par Jetbrain, j'irai voir la conf quand elle sera disponible sur Parleys.  <br/><br/><h1>Changeons la conception de nos applications grâce aux services Cloud</h1>Cette conf donnée par Cyrille Le Clerc est intéressante mais je ne l'ai pas trouvé adaptée au publique, pas assez de code et beaucoup trop de présentation de produits... Elle avait cependant l'intérêt de faire un inventaire des produits, je me suis noté qu'il fallait que la revoie lorsqu'elle sortirai sur Parleys. <br/><br/><h1>An overview of Guava : Google Core Libraries for Java</h1>Ben en fait non, quand je suis arrivé devant la porte, c'était déjà plein, et je me suis donc fait refoulé...<br/>Du coup, je suis retourné voir CodeStory, chose marrante ils ont mis en place un système de Cache à l'aide de Guava :). <br/><br/><h1>Java Caching with Guava</h1>Après avoir vu une utilisation du cache avec Guava, je vais voir la conf théorique sur le sujet. En toute franchise, je me suis rendu compte que rien ne vaux la pratique. J'ai l'impression d'avoir plus appris avec les 10 minutes d'explications par la pratique qu'avec les 55 minutes de conf théorique.<br/>Pour ceux qui ne connaissent pas Guava, je pense que c'est la première dépendance à ajouter sur un projet. Guava c'est apache-common en moderne et mieux fait :). <br/><br/><h1>Android, Graphisme et Performance</h1>Romain Guy (développeur de la couche graphique d'android) nous livre quelques astuces pour réaliser des applications Android qui marchent bien.<br/>Un des trucs que j'ai noté (et que je n'ai pas encore eu le temps de tester), c'est le StrictMode qui permet de faire planter l'application dès qu'on fait un accès à une ressource lente dans le UI Thread. Cela permet de corriger tous les accès qui sont fait dans le UI Thread et qui ne devraient pas. <br/><br/><h1>Les Cast Codeurs Podcast</h1>Pour la dernière "conf" de la journée, je suis aller voir l'enregistrement live des Cast Codeurs. Pour ceux qui ne connaissent pas, c'est LE Podcast Java en France. L'ambiance était excellente, Atlassian distribuait des bières ce qui ne gâcher rien :). Si vous voulez vous rendre compte de l'ambiance, il suffit d'écouter l'épisode associé (<a href="http://lescastcodeurs.com/2012/04/les-cast-codeurs-podcast-episode-57-en-direct-de-devoxx-france-2012/">ici</a>).<br/> Pour les bretons, il y aura un autre enregistrement live au Breizhcamp. <br/><br/><br/>Toutes les conférences de Devoxx France étaient filmées et seront disponible sur Parleys au fil de l'eau durant l'année en gratuit ou rapidement en payant (les participants y ont accès tout de suite).<br/>  Je tiens à remercier les organisateurs (surnommés les polos rouges), et vivement l'année prochaine! <div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-r9wlHR8hfqY/T6kP7JihvyI/AAAAAAAAIjg/Q89npEVwqNQ/s1600/equipe_devoxx_france_2012.jpg" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="234" width="400" src="http://1.bp.blogspot.com/-r9wlHR8hfqY/T6kP7JihvyI/AAAAAAAAIjg/Q89npEVwqNQ/s400/equipe_devoxx_france_2012.jpg" /></a></div>
</p>
                <p><a href="2012/05/retour-de-devoxx-france-troisieme.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2012/04/retour-de-devoxx-france-premiere.html"><h1>Retour de Devoxx France : première journée</h1></a>
                <p>24 avril 2012</p>

                <p>Tags :
                <a href="Devoxx.html">Devoxx</a>, <a href="Java.html">Java</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2012/04/retour-de-devoxx-france-premiere.html" data-text="Retour de Devoxx France : première journée" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2012/04/retour-de-devoxx-france-premiere.html"></div>

                <p>J'ai eu l'occasion de participer à LA grosse conf Java en France, et franchement c'était que du bon.  <br /><h1>Les rencontres</h1>Un des trucs les plus plaisant à Devoxx a été les rencontres que j'ai pu faire et les discussions que j'ai pu avoir avec les speakers et participants. Un exemple : c'est pas tous les jours qu'on a l'occasion de discuter avec un développeur de Montain View qui bosse sur Android (Romain Guy en l'occurrence). Ce n'est pas non plus tous les jours qu'on a l'occasion de développer avec un développeur d'exception (David Gageot).<br/><br/>Je vais donc maintenant essayer de vous faire un petit compte rendu de ces trois jours qui furent très riches!  <br /><br /><h1>Premier jour</h1>Première étape : le café, et les discussions avec les têtes connues et moins connues.<br/>Pour ma part je suis arrivé à 8h tous les matins, ce qui m'a permis de prendre le temps de discuter, les confs ne commençant qu'à 9h30.<br/><br/>La première journée est un peu particulière, elle est principalement consacrée à des "Universités" et des "Hands-on Labs" qui sont des sessions de 3 heures avec pour les Labs de la manip sur son ordi. Ça laisse donc le temps de rentrer un peu plus dans le détail du sujet, et un peu moins le survoler. <br /><br /><h2>Les 3 A pour Java EE 6</h2>Cette session était donc consacrée à Java EE6. Elle s'est déroulée sous forme de TP permettant de mettre en pratique les nouveautés JEE6. Le TP s'appuyait sur le projet exemple initié par Antonio Goncalves.<br/>J'ai profité de cette session pour tester NetBeans, et franchement, pour faire du JEE, c'est juste excellent. On était 2 sous NetBeans sur 40 personnes environ. Ceux qui utilisaient Eclipse ont commencé à avoir un environnement de dev fonctionnel au bout d'un peu plus d'1h, alors que j'avais quasiment fini. J'avais tout de même anticipé en préparant l'environnement la veille. L'absence d'internet sur place rendant toute installation compliquée.<br/>J'ai donc pu mettre en pratique CDI et JAX RS, et j'ai plutôt été agréablement surpris. On va peut être pouvoir <strike>enfin</strike> se passer de Spring :). Les speakers étaient très disponibles et plutôt sympas (ce qui était le cas pour tout les speakers, je ne vais donc pas le répéter :) ). <br /><div class="separator" style="clear: both; text-align: center;"><a href="https://lh4.googleusercontent.com/-bLT0coZ7BJg/T5O84um2AGI/AAAAAAAAFCk/GOGfTHKB3dA/s800/IMG_1098-web.JPG.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="266" src="https://lh4.googleusercontent.com/-bLT0coZ7BJg/T5O84um2AGI/AAAAAAAAFCk/GOGfTHKB3dA/s800/IMG_1098-web.JPG.jpg" width="400" /></a></div><br/>Après cette session, une petite pause déjeuner. J'ai pu manger à ma faim, et sans être exceptionnel (ça vaut pas les galettes saucisses du breizhcamp), c'était plutôt bon, merci donc aux organisateurs. Encore une occasion de discuter et partager avec plein de monde. <br/><br /><h2>Hackergarten Paris</h2>Ne trouvant pas de sujet qui m'intéresse particulièrement, je décide d'aller au Hackergarten. J'ai donc pu découvrir ce que c'est que cette chose imprononçable. C'est en fait l'occasion de contribuer à un projet open-source. La session commence par un inventaire des projets open-source représentés (par un contributeur). Voici ce qui est ressorti de l'inventaire (du moins ceux dont je me souviens) : <br /><ul><li>Maven</li><li>Groovy</li><li>Jenkins</li><li>Infinitest</li><li>Je sais plus mais y en avait d'autre :)</li></ul>Il y avait donc du lourd, j'ai décidé de contribuer à Infinitest. Ce projet se concrétise par un plugin Eclipse et un plugin Intellij permettant d'avoir un état des tests unitaires en permanence dans l'IDE. Dans Eclipse, à chaque build (autant dire tout le temps), le plugin analyse les deltas afin de lancer les tests potentiellement impactés par la modification.<br/>Nous nous somme retrouvés à deux pour contribuer à Infinitest encadrés par David Gageot qui est le Leader du projet. Pendant que David nous présente le code, j'installe l'environnement de dev. David nous présente également une idée de fonctionnalité à réaliser. Actuellement le plugin analyse les dépendances entre classes afin de sélectionner les tests à exécuter, mais si un test est impacté par une modification de fichier plat, il n'est pas exécuté. Sans rentrer dans les détails, cette session c'est traduite par une pull request dans <a href="https://github.com/infinitest/infinitest/pull/84">github</a>, c'était donc plutôt concret. Cela m'a permis de découvrir le développement de plugin Eclipse, et toute la difficulté pour réaliser des tests automatisés dans ce genre d'environnement.<br/><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://lh5.googleusercontent.com/-eXi6PS5kaSc/T5O--oGvOpI/AAAAAAAAH4o/eGCTXphsSB8/s800/IMG_1716-web.JPG.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="266" src="https://lh5.googleusercontent.com/-eXi6PS5kaSc/T5O--oGvOpI/AAAAAAAAH4o/eGCTXphsSB8/s800/IMG_1716-web.JPG.jpg" width="400" /></a></div><br/><br> <h2>Les tools in action</h2>La journée s'est terminée pour ma part par trois tools in action, ce format est un format intense : 30 minutes pour présenter un sujet.<br/><br/>Le premier était sur Selenium Grid, qui permet de mettre en place un pool de browser qui serviront ensuite aux tests automatisés avec Selenium. Malgré toutes les difficultés qu'a pu rencontrer Mathilde Lemee pour les démos, cela donne une bonne idée du fonctionnement de l'outil et donne envie de tester. <br/><br/>Le suivant était sur AndroidAnnotations : sur scène deux speakers (Pierre-Yves Ricau et Alexandre Thomas). AndroidAnnotations est un framework dont le but est de simplifier les développements Android en utilisant massivement les annotations. Les 30 minutes ont quasiment été entièrement utilisées à du live-coding, ça aurait pu être un exercice casse gueule, mais les deux speakers ont préparé leur truc et tout se déroule sans encombre. Résultat : faut que j'essaye, et j'ai bien envie de contribuer au projet.  <br/><br/>La tout dernière session fue consacrée aux lambdas en actions avec la beta du JDK8. Ce que j'ai retenu : enfin une évolution majeure du langage Java. Une conséquence marrante des Lambdas est la quasi introduction du polymorphisme (les interface peuvent maintenant avoir des implémentations par défaut pour les méthodes). <br/><br/>L'article sur la deuxième journée arrivera un peu plus tard :) <br/><br/>Les photos ont été récupérées sur les albums de <a href="https://plus.google.com/photos/100155138787932309893/albums/5734134263593531121">Claude</a>
</p>
                <p><a href="2012/04/retour-de-devoxx-france-premiere.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2012/02/bench-de-moteurcsv.html"><h1>Bench de MoteurCsv</h1></a>
                <p>22 février 2012</p>

                <p>Tags :
                <a href="CSV.html">CSV</a>, <a href="Java.html">Java</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2012/02/bench-de-moteurcsv.html" data-text="Bench de MoteurCsv" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2012/02/bench-de-moteurcsv.html"></div>

                <p>Suite à la publication du billet <a href="/2012/02/moteurcsv-le-jpa-du-csv.html">MoteurCsv le JPA du CSV</a>, quelqu'un m'a demandé si j'avais fait un bench. N'en ayant pas fait, je me suis lancé.<br />Les sources du bench sont disponibles sur <a href="http://github.com/ybonnel/BenchMoteurCsv">github</a><br /><br /><h1> Génération du fichier de test</h1>Le "cahier des charges" fournit par "bbo" était le suivant :<br /><ul><li>~10 000 000 de lignes.</li><li>~200 caractères par ligne.</li><li>~20 champs (4/5 gros champs autour de 20 caractères.)</li></ul>C'est avec ces contraintes que j'ai créé la classe <a href="https://github.com/ybonnel/BenchMoteurCsv/blob/master/src/main/java/fr/ybo/benchmoteurcsv/GenerationFchierCsv.java">GenerationFchierCsv</a>.<br />Cette classe génère donc un fichier de 10 000 000 de lignes contenant des lignes avec 20 champs : <br /><ul><li>Quatre champs de type String et de 30 caractères</li><li>Quatre champs de type Boolean (1 ou 0)</li><li>Quatre champs de type Integer et de 5 chiffres</li><li>Quatre champs de type Double et de 5 chiffres avant la virgule et 5 chiffres après la virgule</li><li>Quatre champs de type String et de 5 caractères</li></ul><br />Voici le résultat de la génération du fichier :<br />Statistiques sur la taille des lignes : <br /><ul><li>Minimum : 215 caractères</li><li>Maximum : 227 caractères</li><li>Moyenne : 225,666 caractères</li></ul>Taille du fichier : 2 266 666 035 octets soit 2,11 Go<br />Génération en 70 576ms <br />Le résultat est donc à peu près conforme au cahier des charges. <br /><br /><h1> Constitution du bench</h1>Le bench est réalisé par la classe <a href="https://github.com/ybonnel/BenchMoteurCsv/blob/master/src/main/java/fr/ybo/benchmoteurcsv/Bench.java">Bench</a> (<span class="Apple-style-span" style="font-size: xx-small;">je sais, je suis trop bon pour trouver des noms</span>).<br />Pour le bench, je ne pouvais pas utiliser la méthode permettant de parser tout le fichier et qui renvoie une liste d'objet. Vu la taille du fichier, il est facile de comprendre que le mettre entièrement en mémoire ne serait pas une bonne idée.<br />Heureusement le moteur contient une autre méthode permettant de réaliser un traitement pour chaque ligne : <a href="http://ybonnel.github.com/MoteurCsv/apidocs/fr/ybo/moteurcsv/MoteurCsv.html#parseFileAndInsert(java.io.Reader,%20java.lang.Class,%20fr.ybo.moteurcsv.modele.InsertObject)">MoteurCsv.parseFileAndInsert</a><br />Dans le cadre du bench j'ai donc utilisé cette méthode en ne réalisant aucun traitement : <br /><pre class="brush: java">public static void bench1() throws FileNotFoundException {<br />    long startTime = System.currentTimeMillis();<br />    moteur.parseFileAndInsert(new FileReader(fichier), ObjetCsv.class,<br />        new InsertObject&lt;objetcsv&gt;() {<br />            @Override<br />            public void insertObject(ObjetCsv objet) {<br />                // On ne fait rien dans le cadre du bench.<br />            }<br />        });<br />    long elapsedTime = (System.currentTimeMillis() - startTime);<br />    System.out.println("Lecture du fichier : " + elapsedTime + "ms");<br />}<br /></pre><br />J'ai également créé une méthode permettant de voir l'utilisation mémoire au fur et à mesure du test.<br />Le but de cette méthode est de regarder la mémoire occupée avant et après un GC entre chaque itération du bench. Cela permettra de vérifier entre autre qu'il n'y ait pas fuite mémoire. <br /><pre class="brush: java">public static void gestionMemoire() {<br />    // Mémoire totale allouée<br />    long totalMemory = Runtime.getRuntime().totalMemory();<br />    // Mémoire utilisée<br />    long currentMemory = totalMemory - Runtime.getRuntime().freeMemory();<br />    System.out.println("Mémoire avant gc : " + (currentMemory / 1024) + "ko/" + (totalMemory / 1024) + "ko");<br />    System.gc();<br />    // Mémoire totale allouée<br />    totalMemory = Runtime.getRuntime().totalMemory();<br />    // Mémoire utilisée<br />    currentMemory = totalMemory - Runtime.getRuntime().freeMemory();<br />    System.out.println("Mémoire après gc : " + (currentMemory / 1024) + "ko/" + (totalMemory / 1024) + "ko");<br />}<br /></pre><h1> Résultats</h1>Les tests ont été menés sur un MacBookPro équipé d'un disque SSD et d'un Code i5.<br /><table class="table table-bordered"><tbody><tr><th>Étape</th><th>Temps</th><th>Mémoire occupée avant GC</th><th>Mémoire occupée après GC</th></tr><tr><td>Avant de commencer</td><td>/</td><td>1 734ko</td><td>338ko</td></tr><tr><td>Instanciation du moteur</td><td>58 222µs</td><td>14 049ko</td><td>387ko</td></tr><tr><td>Lecture du fichier (itération 1)</td><td>65 902ms</td><td>14 049ko</td><td>387ko</td></tr><tr><td>Lecture du fichier (itération 2)</td><td>65 864ms</td><td>13 796ko</td><td>341ko</td></tr><tr><td>Lecture du fichier (itération 3)</td><td>64 638ms</td><td>14 059ko</td><td>341ko</td></tr><tr><td>Lecture du fichier (itération 4)</td><td>65 214ms</td><td>13 700ko</td><td>341ko</td></tr><tr><td>Lecture du fichier (itération 5)</td><td>66 560ms</td><td>14 027ko</td><td>341ko</td></tr></tbody></table><br />Ces résultats permettent de montrer plusieurs choses : <br /><ul><li>Temps pour instancier le moteur : quasi-null</li><li>Mémoire persistante pour le moteur : quelques Ko</li><li>Performances plutôt satisfaisantes avec un peu plus d'une minute pour lire un fichier de plus de 2Go</li></ul><br />J'ai également fait du profiling avec YourKit afin de vérifier le comportement interne du moteur, cela a montré que la majorité du temps est passé dans la librairie open-csv, l'overhead du moteur est donc plutôt faible. <br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-x_0oaHl-krY/T0UwkAidkhI/AAAAAAAAHRM/o8SlmtudCpA/s1600/yourKitMoteurCsv.png" imageanchor="1"><img border="0" height="158" src="http://1.bp.blogspot.com/-x_0oaHl-krY/T0UwkAidkhI/AAAAAAAAHRM/o8SlmtudCpA/s400/yourKitMoteurCsv.png" width="400" /></a></div><br /><h1> Reproduire le bench</h1>N'hésitez pas à reproduire le bench et à me dire les résultats que vous obtenez : <br /><ul><li>Cloner le projet depuis github : <a href="https://github.com/ybonnel/BenchMoteurCsv">github.com/ybonnel/BenchMoteurCsv</a></li><li>Importer le projet en tant que projet maven dans Eclipse</li><li>Lancer d'abord le main de la classe GenerationFchierCsv afin de générer le fichier de test</li><li>Lancer ensuite le main de classe Bench afin de lancer le bench en lui-même</li></ul>Si vous connaissez d'autres parseurs CSV n'hésitez pas à ajouter des benchs dans le projet pour comparer les performances avec d'autres parseurs.
</p>
                <p><a href="2012/02/bench-de-moteurcsv.html#disqus_thread">Commentaires</a></p>
            

        
            
                <a href="../2012/02/moteurcsv-le-jpa-du-csv.html"><h1>MoteurCsv le JPA du CSV</h1></a>
                <p>20 février 2012</p>

                <p>Tags :
                <a href="CSV.html">CSV</a>, <a href="Java.html">Java</a>
                </p>

                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2012/02/moteurcsv-le-jpa-du-csv.html" data-text="MoteurCsv le JPA du CSV" data-via="ybonnel" data-lang="fr">Tweeter</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2012/02/moteurcsv-le-jpa-du-csv.html"></div>

                <p>Voici un titre qui va faire gonfler mes chevilles :)<br />Je vais donc vous présenter une petite librairie Java sans prétention que j'ai réalisé afin de pourvoir lire et écrire des fichiers CSV facilement.<br /><br /><h1>C'est quoi le CSV?</h1>Bon pour la définition du format CSV, je vous invite à consulter l'article <a href="http://fr.wikipedia.org/wiki/Comma-separated_values">wikipedia</a>.<br /><br /><h1>Pourquoi cette librairie?</h1>Cette librairie a été crée afin de pouvoir gérer le format <a href="https://developers.google.com/transit/gtfs/reference">GTFS</a>. Ce format est utilisé afin de décrire un réseau de Transports en commun. Techniquement, c'est un zip contenant des fichiers CSV.<br />J'ai eu à utiliser ce format suite à l'ouverture des données de transports à Rennes où j'ai réalisé une application Android (Transports Rennes) permettant de consulter les horaires de bus.<br />A l'époque où j'ai créé cette librairie, je baignais dans du JPA la journée, et j'avoue que j'aime beaucoup l'idée de décrire du mapping directement dans la classe associé en utilisant des annotations.<br />C'est comme ça que MoteurCsv est né.<br /><br /><h1>Alors comment ça s'utilise?</h1>J'ai essayé de simplifier au maximun l'utilisation de la librairie.<br /><br /><h2>Installation</h2><h3>Maven</h3>Si vous êtes sous maven, l'intégration dans votre projet est très simple.<br />Il suffit d'ajouter dans votre pom.xml :<br /><pre class="brush: xml">&lt;dependencies&gt;<br />    &lt;dependency&gt;<br />        &lt;groupId&gt;fr.ybo&lt;/groupId&gt;<br />        &lt;artifactId&gt;moteurcsv&lt;/artifactId&gt;<br />    &lt;/dependency&gt;<br />&lt;/dependencies&gt;<br /><br />&lt;repositories&gt;<br />    &lt;repository&gt;<br />        &lt;id&gt;ybonnel-release&lt;/id&gt;<br />        &lt;url&gt;https://repository-ybonnel.forge.cloudbees.com/release/&lt;/url&gt;<br />    &lt;/repository&gt;<br />&lt;/repositories&gt;<br /></pre><br /><h3>Autre</h3>Si vous n'êtes pas sous maven, il vous suffit d'intégrer les deux jars suivant :<br /><ul><li><a href="https://github.com/ybonnel/MoteurCsv/downloads">moteurcsv-X.Y.Z.jar</a></li><li><a href="http://sourceforge.net/projects/opencsv/">opencsv-2.3.jar</a></li></ul><br /><h2>Utilisation</h2>Maintenant le vif du sujet, comment utiliser cette petite librairie.<br />Afin de pouvoir lire ou écrire un CSV il faut commencer par décrire la classe correspondante.<br />On va prendre pour l'exemple un CSV décrivant des personnes avec deux colonnes : "nom" et "prenom".<br />Voici un exemple correspondant :<br /><pre class="brush: css">nom,prenom<br />Bonnel,Yan<br />Vador,Dark<br />Noël,Père<br /></pre><br /><h3>Déclaration de la classe</h3>Nous allons donc créer la classe Personne associée avec les annotations permettant de faire le mapping :<br /><br /><pre class="brush: java">// Annotation permettant de dire au moteur que cette classe est associée à un fichier CSV.<br />@FichierCsv<br />public class Personne {<br /><br />    // Annotation permettant de dire au moteur que cet attribut est mappé avec la colonne "nom" du CSV.<br />    @BaliseCsv("nom")<br />    private String nom;<br /><br />    // Annotation permettant de dire au moteur que cet attribut est mappé avec la colonne "prenom" du CSV.<br />    @BaliseCsv("prenom")<br />    private String prenom;<br />}<br /></pre><br /><h3>Création du moteur</h3><pre class="brush: java">MoteurCsv moteur = new MoteurCsv(Personne.class);<br /></pre><br /><h3>Lecture d'un fichier CSV</h3>Voici maintenant le code permettant de lire le fichier, et de le transformer en une liste d'objets :<br /><pre class="brush: java">InputStream stream = new FileInputStream(new File("personnes.csv"));<br />List&lt;Personne&gt; personnes = moteur.parseInputStream(stream, Personne.class);<br /></pre><br /><h3>Écriture d'un fichier CSV</h3>Et le core permettant d'écrire un fichier :<br /><pre class="brush: java">Writer writer = new FileWriter(new File("personnes.csv"));<br />moteur.writeFile(writer, personnes, Personne.class);<br /></pre><br /><h1>Conclusion</h1>J'espère que cette petite librairie sera utile à quelqu'un d'autre que moi :)<br />Elle est open-source (LGPL v3) : <a href="https://github.com/ybonnel/MoteurCsv">github.com/ybonnel/MoteurCsv</a><br />N'hésitez donc pas à forker et à faire des pull request!<br />Site généré contenant entre autre la javadoc : <a href="http://ybonnel.github.com/MoteurCsv">ybonnel.github.com/MoteurCsv</a>
</p>
                <p><a href="2012/02/moteurcsv-le-jpa-du-csv.html#disqus_thread">Commentaires</a></p>
            

        

    </div>

    <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
        <div class="sidebar-module sidebar-module-inset">
            <h4>Yan Bonnel</h4>
            <p>Geek. Technos de prédilections : Java, Android, Git.</p>
        </div>


        <div class="sidebar-module">
            <h4>Tags</h4>
            <ol class="list-unstyled" style="margin-left: 0px">
                

                <li><a href="Java.html">Java</a> (15)</li>
                

                <li><a href="java8.html">java8</a> (6)</li>
                

                <li><a href="SimpleWeb4j.html">SimpleWeb4j</a> (6)</li>
                

                <li><a href="CodeStory.html">CodeStory</a> (5)</li>
                

                <li><a href="Devoxx.html">Devoxx</a> (5)</li>
                

                <li><a href="EventSource.html">EventSource</a> (4)</li>
                

                <li><a href="Server-Sent-Events.html">Server-Sent-Events</a> (4)</li>
                

                <li><a href="SSE.html">SSE</a> (4)</li>
                

                <li><a href="CSV.html">CSV</a> (3)</li>
                

                <li><a href="Jetty.html">Jetty</a> (3)</li>
                

                <li><a href="simple.html">simple</a> (3)</li>
                

                <li><a href="Android.html">Android</a> (2)</li>
                

                <li><a href="javascript.html">javascript</a> (2)</li>
                

                <li><a href="Logo.html">Logo</a> (2)</li>
                

                <li><a href="Rennes.html">Rennes</a> (2)</li>
                

                <li><a href="TDD.html">TDD</a> (2)</li>
                

                <li><a href="websocket.html">websocket</a> (2)</li>
                

                <li><a href="Assertj.html">Assertj</a> (1)</li>
                

                <li><a href="auto-hébergement.html">auto-hébergement</a> (1)</li>
                

                <li><a href="Awaitility.html">Awaitility</a> (1)</li>
                

                <li><a href="blogger.html">blogger</a> (1)</li>
                

                <li><a href="cloud.html">cloud</a> (1)</li>
                

                <li><a href="Comparatif.html">Comparatif</a> (1)</li>
                

                <li><a href="couchbase.html">couchbase</a> (1)</li>
                

                <li><a href="CsvEngine.html">CsvEngine</a> (1)</li>
                

                <li><a href="ExecutorService.html">ExecutorService</a> (1)</li>
                

                <li><a href="git.html">git</a> (1)</li>
                

                <li><a href="github.html">github</a> (1)</li>
                

                <li><a href="Google.html">Google</a> (1)</li>
                

                <li><a href="Groovy.html">Groovy</a> (1)</li>
                

                <li><a href="Jajascript.html">Jajascript</a> (1)</li>
                

                <li><a href="jbake.html">jbake</a> (1)</li>
                

                <li><a href="JEE.html">JEE</a> (1)</li>
                

                <li><a href="json.html">json</a> (1)</li>
                

                <li><a href="NoMock.html">NoMock</a> (1)</li>
                

                <li><a href="OneDay.html">OneDay</a> (1)</li>
                

                <li><a href="OnePost.html">OnePost</a> (1)</li>
                

                <li><a href="reactive.html">reactive</a> (1)</li>
                

                <li><a href="REST.html">REST</a> (1)</li>
                

                <li><a href="Scalaskel.html">Scalaskel</a> (1)</li>
                
            </ol>
        </div>
    </div>

    </div>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="text-muted credit">L'ensemble des posts de ce blog sont publiés sous licence <em>Creative Commons by-nc-sa</em>. <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a></p>
        <p class="text-muted credit">&copy; 2013 | Mixed with <a href="http://twitter.github.com/bootstrap/">Bootstrap v3.0.2</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- script src="/js/jquery-1.10.2.min.js"></script -->
    <!-- script src="/js/bootstrap.min.js"></script -->
    <script src="../js/run_prettify.js"></script>

    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shCore.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushCss.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushJava.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushJScript.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushSql.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushVb.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushXml.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushBash.js' type='text/javascript'></script>


    <script language='javascript'>
        SyntaxHighlighter.config.bloggerMode = true;
        SyntaxHighlighter.all();
    </script>


    <script type="text/javascript">
        window.___gcfg = {lang: 'fr'};

        (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-28563381-1', 'www.ybonnel.fr');
      ga('send', 'pageview');

    </script>
    
  </body>
</html>

