title=Mes premiers pas avec CouchBase
date=2013-05-28
type=post
tags=couchbase
status=published
id=mes-premiers-pas-avec-couchbase
~~~~~~
 Pour ceux qui ne connaissent pas, CouchBase est une base NoSQL orientée document (type MongoDB). Le but ici n'est pas de vous faire un cours sur les bases NoSQL, mais plutôt de vous faire un retour très concret sur mes premiers pas opérationnels avec celle-ci.<br/><br/><h1>Contexte</h1>Comme certains d'entre vous le savent sûrement je suis l'auteur d'un programme télé disponible en tant qu'<a href="https://play.google.com/store/apps/details?id=fr.ybo.ybotv.android">application Android</a> et en tant que <a href="http://ybo-tv.ybonnel.fr">site web</a>. Avant ma refonte vers CouchBase, le serveur fonctionnait avec un gros cache mémoire chargé à partir d'un fichier xml lui-même mis à jour toute les nuits. Depuis quelques semaines, j'avais des problèmes avec la source de mes données, il fallait donc que je change de source, j'en ai donc profité pour changer l'architecture.<br/><br/><br/> <h1>Nouvelle architecture</h1>J'ai un batch qui tourne toute les nuits pour récupérer les données et qui les insère dans la base CouchBase, le serveur se contente donc de requêter CouchBase<br/><br/><br/> <h1>Mise en place</h1> <h2>Installation de CouchBase</h2>C'est le point ultra positif de CouchBase: l'installation. J'ai rarement vu une installation aussi simple. Le produit dispose d'une interface d'administration plutôt sexy, ça évite d'avoir besoin d'une formation de 5 jours et d'une certification pour être capable d’administrer la chose! Je vous invite donc à aller consulter la doc sur ce point, elle est largement suffisante.<br/><br/> <h2>Mise en place du client java</h2>Premier reproche que je peux faire à CouchBase: le client java n'est pas disponible sur le central, ce qui oblige à ajouter le repository CouchBase à la main...<br/>Voici donc comment ajouter le client dans le pom.xml : <pre class="brush:xml"><br />&lt;dependencies&gt;<br />    &lt;dependency&gt;<br />        &lt;groupId&gt;couchbase&lt;/groupId&gt;<br />        &lt;artifactId&gt;couchbase-client&lt;/artifactId&gt;<br />        &lt;version&gt;1.1.4&lt;/version&gt;<br />    &lt;/dependency&gt;<br />&lt;/dependencies&gt;<br /><br />&lt;repositories&gt;<br />    &lt;repository&gt;<br />        &lt;id&gt;couchbase&lt;/id&gt;<br />        &lt;name&gt;Couchbase Maven Repository&lt;/name&gt;<br />        &lt;layout&gt;default&lt;/layout&gt;<br />        &lt;url&gt;http://files.couchbase.com/maven2/&lt;/url&gt;<br />        &lt;snapshots&gt;<br />            &lt;enabled&gt;false&lt;/enabled&gt;<br />        &lt;/snapshots&gt;<br />    &lt;/repository&gt;<br />&lt;/repositories&gt;<br /></pre><br/> <h2>Batch nocturne : insertion en masse</h2>La première partie qu'il a fallu mettre en place est le peuplement de cette base avec le programme télé courant.<br/>Voici donc le contenu de la méthode chargée de cette insertion : <pre class="brush:java"><br />/**<br /> * Insertion du programme télé.<br /> * @param tv programme télé contenant la liste<br /> *        des chaînes et la liste des programmes.<br /> */<br />private static void insertIntoCouchbase(TvForCouchBase tv)<br />        throws URISyntaxException, IOException,<br />               ExecutionException, InterruptedException {<br />    // Création de l'instance jackson pour la serialisation json<br />    ObjectMapper mapper = new ObjectMapper();<br />    mapper.setSerializationInclusion(JsonInclude.Include.NON_EMPTY);<br /><br />    // Création du client CouchBase.<br />    CouchbaseClient client = new CouchbaseClient(<br />            newArrayList(new URI("http://127.0.0.1:8091/pools")), "default", "");<br /><br />    logger.info("Insert channels");<br />    // Transformation des chaines en json.<br />    String channelIntoJson = mapper.writeValueAsString(tv.getChannel());<br />    // Insertion des chaines<br />    client.set(<br />            "channels", // Clé unique pour la liste des chaines.<br />            (int) TimeUnit.DAYS.toSeconds(3), // Purger au bout de trois jours.<br />            channelIntoJson, // liste des chaînes<br />            PersistTo.ZERO // On attend pas que se soit persister sur disque.<br />    ).get();<br /><br />    logger.info("Insert programs");<br />    for (ProgrammeForCouchBase programme : tv.getProgramme()) {<br />        // Transformation d'un programme en json. <br />        String programmeIntoJson = mapper.writeValueAsString(programme);<br />        // Insertion du programme.<br />        client.set(<br />                "prg_" + programme.getId(), // Clé unique du programme<br />                (int) TimeUnit.DAYS.toSeconds(3), // Purger au bout de trois jours.<br />                programmeIntoJson, // Le programme<br />                PersistTo.ZERO // On attend pas que se soit persister sur disque.<br />        ).get();<br />    }<br /><br />    // On arrête le client.<br />    client.shutdown(30, TimeUnit.SECONDS);<br />}<br /></pre><br/> <h2>Serveur : les queries</h2>Une fois l'index créé sur la console d'administration de CouchBase, le requêtage est très simple. J'ai par exemple créé un index permettant de récupérer tout les programmes associés à une chaine. Le code de l'index (appelé "view" dans CouchBase) est du javascript très simple : <pre class="brush:js"><br />function (doc, meta) {<br />  if (doc.channel) {<br />    emit(doc.channel, null);<br />  }<br />}<br /></pre> Il faut ensuite récupérer les données côté client : <pre class="brush:java"><br />// Récupération du client CouchBase(singleton maison)<br />CouchbaseClient client = CouchBaseService.INSTANCE.getClient();<br />// Mapper permettant de transformer le json en objet.<br />ObjectMapper mapper = CouchBaseService.INSTANCE.getMapper();<br /><br />// Récupération de la vue.<br />View view = client.getView("programme", "by_channel");<br />// Création de la query<br />Query query = new Query();<br />query.setKey(ComplexKey.of(channel));<br />// On inclut les documents dans la réponse pour ne pas avoir à ré-appeler CouchBase.<br />query.setIncludeDocs(true);<br /><br />List&lt;Programme&gt; programmes = new ArrayList&lt;Programme&gt;();<br />for (ViewRow row : client.query(view, query)) {<br />    // Pour chaque ligne de la réponse de CouchBase,<br />    // on transforme le document en objet.<br />    programmes.add(mapper.readValue(<br />            (String) row.getDocument(), <br />            Programme.class));<br />}<br /></pre> Comme on le voit, l'intégration se fait tout en douceur, rien de bien compliqué.<br/><br/>  <h1>Conclusion</h1>Dans l'ensemble je suis très satisfait de CouchBase, les points positifs sont : api très simple, installation très simple, console d'administration réellement digne de ce nom.<br/>Seuls deux points m'ont un peu déçu.<br/>Le premier est le fait que la librairie Java ne soit pas déployée dans le central maven (je déteste ajouter des repository tierces dans mon pom.xml...). <br/>Le deuxième point ne concerne pas directement l'utilisation, il s'agit de la configuration choisie pour le build de la librairie Java. J'ai trouvé une anomalie dans le code de la librairie java, j'ai donc voulu faire une pull request pour la corriger. J'ai donc récupéré les sources, et me suis aperçu que le build est fait via "ant", étant allergique à "ant", je ne suis pas allé plus loin (l'anomalie a quand même été corrigée par l'équipe CouchBase). De même dans le README de la librairie, aucune info sur la contribution, que des infos sur l'utilisation...<br/>Malgré ces deux points, je reste ultra-satisfait de CouchBase, son utilisation est simple, et quand on montre la console d'administration, tout le monde est séduit!<br/><br/>En bref, essayer CouchBase c'est l'adopter!
