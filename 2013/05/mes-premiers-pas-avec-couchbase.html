<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>JustAnOtherDevBlog - Mes premiers pas avec CouchBase</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">    

    <!-- Le styles -->
    <link href="../../css/yeti/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <!-- link href="/css/bootstrap-theme.min.css" rel="stylesheet" -->
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
    <link href='http://alexgorbatchev.com/pub/sh/3.0.83/styles/shCore.css' rel='stylesheet' type='text/css'/>
    <link href='http://alexgorbatchev.com/pub/sh/3.0.83/styles/shThemeDefault.css' rel='stylesheet' type='text/css'/>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../favicon.ico">
  </head>
  <body>
    <div id="wrap">
	
      <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-menu">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../../index.html">JustAnOtherDevBlog</a>
          </div>
          <div class="collapse navbar-collapse" id="navbar-menu">
            <ul class="nav navbar-nav">
              <li><a href="https://github.com/ybonnel" target="github:ybonnel">Github</a></li>
              <li><a href="/feeds/posts/default">Flux RSS</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
      <div class="container">
	
	<div class="page-header">
		<h1>Mes premiers pas avec CouchBase</h1>
	</div>

	<p><em>28 mai 2013</em></p>

    <p>Tags :
            <a href="../../tags/couchbase.html">couchbase</a>
    </p>
        <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2013/05/mes-premiers-pas-avec-couchbase.html" data-via="ybonnel" data-text="Mes premiers pas avec CouchBase" data-lang="fr">Tweeter</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2013/05/mes-premiers-pas-avec-couchbase.html"></div>

	<p> Pour ceux qui ne connaissent pas, CouchBase est une base NoSQL orientée document (type MongoDB). Le but ici n'est pas de vous faire un cours sur les bases NoSQL, mais plutôt de vous faire un retour très concret sur mes premiers pas opérationnels avec celle-ci.<br/><br/><h1>Contexte</h1>Comme certains d'entre vous le savent sûrement je suis l'auteur d'un programme télé disponible en tant qu'<a href="https://play.google.com/store/apps/details?id=fr.ybo.ybotv.android">application Android</a> et en tant que <a href="http://ybo-tv.ybonnel.fr">site web</a>. Avant ma refonte vers CouchBase, le serveur fonctionnait avec un gros cache mémoire chargé à partir d'un fichier xml lui-même mis à jour toute les nuits. Depuis quelques semaines, j'avais des problèmes avec la source de mes données, il fallait donc que je change de source, j'en ai donc profité pour changer l'architecture.<br/><br/><br/> <h1>Nouvelle architecture</h1>J'ai un batch qui tourne toute les nuits pour récupérer les données et qui les insère dans la base CouchBase, le serveur se contente donc de requêter CouchBase<br/><br/><br/> <h1>Mise en place</h1> <h2>Installation de CouchBase</h2>C'est le point ultra positif de CouchBase: l'installation. J'ai rarement vu une installation aussi simple. Le produit dispose d'une interface d'administration plutôt sexy, ça évite d'avoir besoin d'une formation de 5 jours et d'une certification pour être capable d’administrer la chose! Je vous invite donc à aller consulter la doc sur ce point, elle est largement suffisante.<br/><br/> <h2>Mise en place du client java</h2>Premier reproche que je peux faire à CouchBase: le client java n'est pas disponible sur le central, ce qui oblige à ajouter le repository CouchBase à la main...<br/>Voici donc comment ajouter le client dans le pom.xml : <pre class="brush:xml"><br />&lt;dependencies&gt;<br />    &lt;dependency&gt;<br />        &lt;groupId&gt;couchbase&lt;/groupId&gt;<br />        &lt;artifactId&gt;couchbase-client&lt;/artifactId&gt;<br />        &lt;version&gt;1.1.4&lt;/version&gt;<br />    &lt;/dependency&gt;<br />&lt;/dependencies&gt;<br /><br />&lt;repositories&gt;<br />    &lt;repository&gt;<br />        &lt;id&gt;couchbase&lt;/id&gt;<br />        &lt;name&gt;Couchbase Maven Repository&lt;/name&gt;<br />        &lt;layout&gt;default&lt;/layout&gt;<br />        &lt;url&gt;http://files.couchbase.com/maven2/&lt;/url&gt;<br />        &lt;snapshots&gt;<br />            &lt;enabled&gt;false&lt;/enabled&gt;<br />        &lt;/snapshots&gt;<br />    &lt;/repository&gt;<br />&lt;/repositories&gt;<br /></pre><br/> <h2>Batch nocturne : insertion en masse</h2>La première partie qu'il a fallu mettre en place est le peuplement de cette base avec le programme télé courant.<br/>Voici donc le contenu de la méthode chargée de cette insertion : <pre class="brush:java"><br />/**<br /> * Insertion du programme télé.<br /> * @param tv programme télé contenant la liste<br /> *        des chaînes et la liste des programmes.<br /> */<br />private static void insertIntoChouchbase(TvForCouchBase tv)<br />        throws URISyntaxException, IOException,<br />               ExecutionException, InterruptedException {<br />    // Création de l'instance jackson pour la serialisation json<br />    ObjectMapper mapper = new ObjectMapper();<br />    mapper.setSerializationInclusion(JsonInclude.Include.NON_EMPTY);<br /><br />    // Création du client CouchBase.<br />    CouchbaseClient client = new CouchbaseClient(<br />            newArrayList(new URI("http://127.0.0.1:8091/pools")), "default", "");<br /><br />    logger.info("Insert channels");<br />    // Transformation des chaines en json.<br />    String channelIntoJson = mapper.writeValueAsString(tv.getChannel());<br />    // Insertion des chaines<br />    client.set(<br />            "channels", // Clé unique pour la liste des chaines.<br />            (int) TimeUnit.DAYS.toSeconds(3), // Purger au bout de trois jours.<br />            channelIntoJson, // liste des chaînes<br />            PersistTo.ZERO // On attend pas que se soit persister sur disque.<br />    ).get();<br /><br />    logger.info("Insert programs");<br />    for (ProgrammeForCouchBase programme : tv.getProgramme()) {<br />        // Transformation d'un programme en json. <br />        String programmeIntoJson = mapper.writeValueAsString(programme);<br />        // Insertion du programme.<br />        client.set(<br />                "prg_" + programme.getId(), // Clé unique du programme<br />                (int) TimeUnit.DAYS.toSeconds(3), // Purger au bout de trois jours.<br />                programmeIntoJson, // Le programme<br />                PersistTo.ZERO // On attend pas que se soit persister sur disque.<br />        ).get();<br />    }<br /><br />    // On arrête le client.<br />    client.shutdown(30, TimeUnit.SECONDS);<br />}<br /></pre><br/> <h2>Serveur : les queries</h2>Une fois l'index créé sur la console d'administration de CouchBase, le requêtage est très simple. J'ai par exemple créé un index permettant de récupérer tout les programmes associés à une chaine. Le code de l'index (appelé "view" dans CouchBase) est du javascript très simple : <pre class="brush:js"><br />function (doc, meta) {<br />  if (doc.channel) {<br />    emit(doc.channel, null);<br />  }<br />}<br /></pre> Il faut ensuite récupérer les données côté client : <pre class="brush:java"><br />// Récupération du client CouchBase(singleton maison)<br />CouchbaseClient client = CouchBaseService.INSTANCE.getClient();<br />// Mapper permettant de transformer le json en objet.<br />ObjectMapper mapper = CouchBaseService.INSTANCE.getMapper();<br /><br />// Récupération de la vue.<br />View view = client.getView("programme", "by_channel");<br />// Création de la query<br />Query query = new Query();<br />query.setKey(ComplexKey.of(channel));<br />// On inclut les documents dans la réponse pour ne pas avoir à ré-appeler CouchBase.<br />query.setIncludeDocs(true);<br /><br />List&lt;Programme&gt; programmes = new ArrayList&lt;Programme&gt;();<br />for (ViewRow row : client.query(view, query)) {<br />    // Pour chaque ligne de la réponse de CouchBase,<br />    // on transforme le document en objet.<br />    programmes.add(mapper.readValue(<br />            (String) row.getDocument(), <br />            Programme.class));<br />}<br /></pre> Comme on le voit, l'intégration se fait tout en douceur, rien de bien compliqué.<br/><br/>  <h1>Conclusion</h1>Dans l'ensemble je suis très satisfait de CouchBase, les points positifs sont : api très simple, installation très simple, console d'administration réellement digne de ce nom.<br/>Seuls deux points m'ont un peu déçu.<br/>Le premier est le fait que la librairie Java ne soit pas déployée dans le central maven (je déteste ajouter des repository tierces dans mon pom.xml...). <br/>Le deuxième point ne concerne pas directement l'utilisation, il s'agit de la configuration choisie pour le build de la librairie Java. J'ai trouvé une anomalie dans le code de la librairie java, j'ai donc voulu faire une pull request pour la corriger. J'ai donc récupéré les sources, et me suis aperçu que le build est fait via "ant", étant allergique à "ant", je ne suis pas allé plus loin (l'anomalie a quand même été corrigée par l'équipe CouchBase). De même dans le README de la librairie, aucune info sur la contribution, que des infos sur l'utilisation...<br/>Malgré ces deux points, je reste ultra-satisfait de CouchBase, son utilisation est simple, et quand on montre la console d'administration, tout le monde est séduit!<br/><br/>En bref, essayer CouchBase c'est l'adopter!  
</p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'ybonnel';
            var disqus_identifier = 'mes-premiers-pas-avec-couchbase';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>

	<hr>
	
		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="text-muted credit">L'ensemble des posts de ce blog sont publiés sous licence <em>Creative Commons by-nc-sa</em>. <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a></p>
        <p class="text-muted credit">&copy; 2013 | Mixed with <a href="http://twitter.github.com/bootstrap/">Bootstrap v3.0.2</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- script src="/js/jquery-1.10.2.min.js"></script -->
    <!-- script src="/js/bootstrap.min.js"></script -->
    <script src="../../js/run_prettify.js"></script>

    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shCore.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushCss.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushJava.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushJScript.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushSql.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushVb.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushXml.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushBash.js' type='text/javascript'></script>


    <script language='javascript'>
        SyntaxHighlighter.config.bloggerMode = true;
        SyntaxHighlighter.all();
    </script>


    <script type="text/javascript">
        window.___gcfg = {lang: 'fr'};

        (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-28563381-1', 'www.ybonnel.fr');
      ga('send', 'pageview');

    </script>
    
  </body>
</html>
