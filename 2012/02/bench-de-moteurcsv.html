<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    
    <title>JustAnOtherDevBlog - Bench de MoteurCsv</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="JustAnOtherDevBlog : Bench de MoteurCsv">
    <meta property="og:title" content="JustAnOtherDevBlog - Bench de MoteurCsv" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="http://www.ybonnel.fr/img/JustAnOtherDevBlog.png" />
    <meta property="og:url" content="http://www.ybonnel.fr" />
    <meta property="og:description" content="JustAnOtherDevBlog : Bench de MoteurCsv" />
    <meta property="og:locale" content="fr_FR" />
    <meta property="og:site_name" content="JustAnOtherDevBlog" />

    <!-- Le styles -->
    <link href="../../css/yeti/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/asciidoctor.css" rel="stylesheet">
    <!-- link href="/css/bootstrap-theme.min.css" rel="stylesheet" -->
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
    <link href='http://alexgorbatchev.com/pub/sh/3.0.83/styles/shCore.css' rel='stylesheet' type='text/css'/>
    <link href='http://alexgorbatchev.com/pub/sh/3.0.83/styles/shThemeDefault.css' rel='stylesheet' type='text/css'/>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../favicon.ico">
  </head>
  <body>
    <div id="wrap">

	
	      <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-menu">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../../index.html">JustAnOtherDevBlog</a>
          </div>
          <div class="collapse navbar-collapse" id="navbar-menu">
            <ul class="nav navbar-nav">
              <li><a href="https://github.com/ybonnel" target="github:ybonnel">Github</a></li>
              <li><a href="../../archive.html">Archives</a></li>
              <li><a href="../../feeds/posts/default.xml">Flux RSS</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
      <div class="container">

	
	<div class="page-header">
        <div class="row">
            <div class="col-xs-4 col-md-2"><img src="../../img/JustAnOtherDevBlog.png"></div>
            <div class="col-xs-12 col-md-8"><h1>Bench de MoteurCsv</h1></div>
        </div>
	</div>

    <div class="row">

        <div class="col-sm-8" itemscope itemtype="http://schema.org/Blog">

        <p>
            <em>
                <time itemprop="datePublished"
                      datetime="2012-02-22">
                    22 février 2012
                </time>
            </em>
        </p>

        <meta itemprop="name" content="Bench de MoteurCsv"/>

        <div itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="name" content="Yan Bonnel"/>
        </div>
        <meta itemprop="inLanguage" content="fr-FR"/>
        <meta itemprop="url" content="http://www.ybonnel.fr/2012/02/bench-de-moteurcsv.html"/>
        <meta itemprop="discussionUrl" content="http://www.ybonnel.fr/2012/02/bench-de-moteurcsv.html#disqus_thread"/>



        <p>Tags :
        <meta itemprop="keywords" content="CSV,Java"/>
        <a href="../../tags/CSV.html">CSV</a>, <a href="../../tags/Java.html">Java</a>
        </p>

        <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.ybonnel.fr/2012/02/bench-de-moteurcsv.html" data-via="ybonnel" data-text="Bench de MoteurCsv" data-lang="fr">Tweeter</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        <div class="g-plusone" data-size="medium" data-href="http://www.ybonnel.fr/2012/02/bench-de-moteurcsv.html"></div>

        <div itemprop="blogPost">
        <p>Suite à la publication du billet <a href="/2012/02/moteurcsv-le-jpa-du-csv.html">MoteurCsv le JPA du CSV</a>, quelqu'un m'a demandé si j'avais fait un bench. N'en ayant pas fait, je me suis lancé.<br />Les sources du bench sont disponibles sur <a href="http://github.com/ybonnel/BenchMoteurCsv">github</a><br /><br /><h1> Génération du fichier de test</h1>Le "cahier des charges" fournit par "bbo" était le suivant :<br /><ul><li>~10 000 000 de lignes.</li><li>~200 caractères par ligne.</li><li>~20 champs (4/5 gros champs autour de 20 caractères.)</li></ul>C'est avec ces contraintes que j'ai créé la classe <a href="https://github.com/ybonnel/BenchMoteurCsv/blob/master/src/main/java/fr/ybo/benchmoteurcsv/GenerationFchierCsv.java">GenerationFchierCsv</a>.<br />Cette classe génère donc un fichier de 10 000 000 de lignes contenant des lignes avec 20 champs : <br /><ul><li>Quatre champs de type String et de 30 caractères</li><li>Quatre champs de type Boolean (1 ou 0)</li><li>Quatre champs de type Integer et de 5 chiffres</li><li>Quatre champs de type Double et de 5 chiffres avant la virgule et 5 chiffres après la virgule</li><li>Quatre champs de type String et de 5 caractères</li></ul><br />Voici le résultat de la génération du fichier :<br />Statistiques sur la taille des lignes : <br /><ul><li>Minimum : 215 caractères</li><li>Maximum : 227 caractères</li><li>Moyenne : 225,666 caractères</li></ul>Taille du fichier : 2 266 666 035 octets soit 2,11 Go<br />Génération en 70 576ms <br />Le résultat est donc à peu près conforme au cahier des charges. <br /><br /><h1> Constitution du bench</h1>Le bench est réalisé par la classe <a href="https://github.com/ybonnel/BenchMoteurCsv/blob/master/src/main/java/fr/ybo/benchmoteurcsv/Bench.java">Bench</a> (<span class="Apple-style-span" style="font-size: xx-small;">je sais, je suis trop bon pour trouver des noms</span>).<br />Pour le bench, je ne pouvais pas utiliser la méthode permettant de parser tout le fichier et qui renvoie une liste d'objet. Vu la taille du fichier, il est facile de comprendre que le mettre entièrement en mémoire ne serait pas une bonne idée.<br />Heureusement le moteur contient une autre méthode permettant de réaliser un traitement pour chaque ligne : <a href="http://ybonnel.github.com/MoteurCsv/apidocs/fr/ybo/moteurcsv/MoteurCsv.html#parseFileAndInsert(java.io.Reader,%20java.lang.Class,%20fr.ybo.moteurcsv.modele.InsertObject)">MoteurCsv.parseFileAndInsert</a><br />Dans le cadre du bench j'ai donc utilisé cette méthode en ne réalisant aucun traitement : <br /><pre class="brush: java">public static void bench1() throws FileNotFoundException {<br />    long startTime = System.currentTimeMillis();<br />    moteur.parseFileAndInsert(new FileReader(fichier), ObjetCsv.class,<br />        new InsertObject&lt;objetcsv&gt;() {<br />            @Override<br />            public void insertObject(ObjetCsv objet) {<br />                // On ne fait rien dans le cadre du bench.<br />            }<br />        });<br />    long elapsedTime = (System.currentTimeMillis() - startTime);<br />    System.out.println("Lecture du fichier : " + elapsedTime + "ms");<br />}<br /></pre><br />J'ai également créé une méthode permettant de voir l'utilisation mémoire au fur et à mesure du test.<br />Le but de cette méthode est de regarder la mémoire occupée avant et après un GC entre chaque itération du bench. Cela permettra de vérifier entre autre qu'il n'y ait pas fuite mémoire. <br /><pre class="brush: java">public static void gestionMemoire() {<br />    // Mémoire totale allouée<br />    long totalMemory = Runtime.getRuntime().totalMemory();<br />    // Mémoire utilisée<br />    long currentMemory = totalMemory - Runtime.getRuntime().freeMemory();<br />    System.out.println("Mémoire avant gc : " + (currentMemory / 1024) + "ko/" + (totalMemory / 1024) + "ko");<br />    System.gc();<br />    // Mémoire totale allouée<br />    totalMemory = Runtime.getRuntime().totalMemory();<br />    // Mémoire utilisée<br />    currentMemory = totalMemory - Runtime.getRuntime().freeMemory();<br />    System.out.println("Mémoire après gc : " + (currentMemory / 1024) + "ko/" + (totalMemory / 1024) + "ko");<br />}<br /></pre><h1> Résultats</h1>Les tests ont été menés sur un MacBookPro équipé d'un disque SSD et d'un Code i5.<br /><table class="table table-bordered"><tbody><tr><th>Étape</th><th>Temps</th><th>Mémoire occupée avant GC</th><th>Mémoire occupée après GC</th></tr><tr><td>Avant de commencer</td><td>/</td><td>1 734ko</td><td>338ko</td></tr><tr><td>Instanciation du moteur</td><td>58 222µs</td><td>14 049ko</td><td>387ko</td></tr><tr><td>Lecture du fichier (itération 1)</td><td>65 902ms</td><td>14 049ko</td><td>387ko</td></tr><tr><td>Lecture du fichier (itération 2)</td><td>65 864ms</td><td>13 796ko</td><td>341ko</td></tr><tr><td>Lecture du fichier (itération 3)</td><td>64 638ms</td><td>14 059ko</td><td>341ko</td></tr><tr><td>Lecture du fichier (itération 4)</td><td>65 214ms</td><td>13 700ko</td><td>341ko</td></tr><tr><td>Lecture du fichier (itération 5)</td><td>66 560ms</td><td>14 027ko</td><td>341ko</td></tr></tbody></table><br />Ces résultats permettent de montrer plusieurs choses : <br /><ul><li>Temps pour instancier le moteur : quasi-null</li><li>Mémoire persistante pour le moteur : quelques Ko</li><li>Performances plutôt satisfaisantes avec un peu plus d'une minute pour lire un fichier de plus de 2Go</li></ul><br />J'ai également fait du profiling avec YourKit afin de vérifier le comportement interne du moteur, cela a montré que la majorité du temps est passé dans la librairie open-csv, l'overhead du moteur est donc plutôt faible. <br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-x_0oaHl-krY/T0UwkAidkhI/AAAAAAAAHRM/o8SlmtudCpA/s1600/yourKitMoteurCsv.png" imageanchor="1"><img border="0" height="158" src="http://1.bp.blogspot.com/-x_0oaHl-krY/T0UwkAidkhI/AAAAAAAAHRM/o8SlmtudCpA/s400/yourKitMoteurCsv.png" width="400" /></a></div><br /><h1> Reproduire le bench</h1>N'hésitez pas à reproduire le bench et à me dire les résultats que vous obtenez : <br /><ul><li>Cloner le projet depuis github : <a href="https://github.com/ybonnel/BenchMoteurCsv">github.com/ybonnel/BenchMoteurCsv</a></li><li>Importer le projet en tant que projet maven dans Eclipse</li><li>Lancer d'abord le main de la classe GenerationFchierCsv afin de générer le fichier de test</li><li>Lancer ensuite le main de classe Bench afin de lancer le bench en lui-même</li></ul>Si vous connaissez d'autres parseurs CSV n'hésitez pas à ajouter des benchs dans le projet pour comparer les performances avec d'autres parseurs.
</p>
        </div>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'ybonnel';
            var disqus_identifier = 'bench-de-moteurcsv';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
    </div>

    <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
        <div class="sidebar-module sidebar-module-inset">
            <h4>Yan Bonnel</h4>
            <p>Geek. Technos de prédilections : Java, Android, Git.</p>
            <ul>
                <li><a href="https://twitter.com/ybonnel">@ybonnel</a></li>
                <li><a href="https://plus.google.com/u/0/+yanbonnel?rel=author">+yanbonnel</a></li>
            </ul>
        </div>

        <div class="sidebar-module">
            <h4>Tags</h4>
            <ol class="list-unstyled" style="margin-left: 0px">
                

                <li><a href="../../tags/Java.html">Java</a> (15)</li>
                

                <li><a href="../../tags/java8.html">java8</a> (6)</li>
                

                <li><a href="../../tags/SimpleWeb4j.html">SimpleWeb4j</a> (6)</li>
                

                <li><a href="../../tags/CodeStory.html">CodeStory</a> (5)</li>
                

                <li><a href="../../tags/Devoxx.html">Devoxx</a> (5)</li>
                

                <li><a href="../../tags/EventSource.html">EventSource</a> (4)</li>
                

                <li><a href="../../tags/Server-Sent-Events.html">Server-Sent-Events</a> (4)</li>
                

                <li><a href="../../tags/SSE.html">SSE</a> (4)</li>
                

                <li><a href="../../tags/CSV.html">CSV</a> (3)</li>
                

                <li><a href="../../tags/Jetty.html">Jetty</a> (3)</li>
                

                <li><a href="../../tags/simple.html">simple</a> (3)</li>
                

                <li><a href="../../tags/Android.html">Android</a> (2)</li>
                

                <li><a href="../../tags/blogger.html">blogger</a> (2)</li>
                

                <li><a href="../../tags/github.html">github</a> (2)</li>
                

                <li><a href="../../tags/javascript.html">javascript</a> (2)</li>
                

                <li><a href="../../tags/jbake.html">jbake</a> (2)</li>
                

                <li><a href="../../tags/Logo.html">Logo</a> (2)</li>
                

                <li><a href="../../tags/Rennes.html">Rennes</a> (2)</li>
                

                <li><a href="../../tags/TDD.html">TDD</a> (2)</li>
                

                <li><a href="../../tags/websocket.html">websocket</a> (2)</li>
                

                <li><a href="../../tags/Assertj.html">Assertj</a> (1)</li>
                

                <li><a href="../../tags/auto-hébergement.html">auto-hébergement</a> (1)</li>
                

                <li><a href="../../tags/Awaitility.html">Awaitility</a> (1)</li>
                

                <li><a href="../../tags/cloud.html">cloud</a> (1)</li>
                

                <li><a href="../../tags/Comparatif.html">Comparatif</a> (1)</li>
                

                <li><a href="../../tags/couchbase.html">couchbase</a> (1)</li>
                

                <li><a href="../../tags/CsvEngine.html">CsvEngine</a> (1)</li>
                

                <li><a href="../../tags/ExecutorService.html">ExecutorService</a> (1)</li>
                

                <li><a href="../../tags/git.html">git</a> (1)</li>
                

                <li><a href="../../tags/Google.html">Google</a> (1)</li>
                

                <li><a href="../../tags/Groovy.html">Groovy</a> (1)</li>
                

                <li><a href="../../tags/Jajascript.html">Jajascript</a> (1)</li>
                

                <li><a href="../../tags/JEE.html">JEE</a> (1)</li>
                

                <li><a href="../../tags/json.html">json</a> (1)</li>
                

                <li><a href="../../tags/NoMock.html">NoMock</a> (1)</li>
                

                <li><a href="../../tags/OneDay.html">OneDay</a> (1)</li>
                

                <li><a href="../../tags/OnePost.html">OnePost</a> (1)</li>
                

                <li><a href="../../tags/reactive.html">reactive</a> (1)</li>
                

                <li><a href="../../tags/REST.html">REST</a> (1)</li>
                

                <li><a href="../../tags/Scalaskel.html">Scalaskel</a> (1)</li>
                
            </ol>
        </div>
    </div>
	
		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="text-muted credit">L'ensemble des posts de ce blog sont publiés sous licence <em>Creative Commons by-nc-sa</em>. <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a></p>
        <p class="text-muted credit">&copy; 2013 | Mixed with <a href="http://twitter.github.com/bootstrap/">Bootstrap v3.0.2</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- script src="/js/jquery-1.10.2.min.js"></script -->
    <!-- script src="/js/bootstrap.min.js"></script -->
    <script src="../../js/run_prettify.js"></script>

    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shCore.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushCss.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushJava.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushJScript.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushSql.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushVb.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushXml.js' type='text/javascript'></script>
    <script src='http://alexgorbatchev.com/pub/sh/3.0.83/scripts/shBrushBash.js' type='text/javascript'></script>


    <script language='javascript'>
        SyntaxHighlighter.config.bloggerMode = true;
        SyntaxHighlighter.all();
    </script>


    <script type="text/javascript">
        window.___gcfg = {lang: 'fr'};

        (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-28563381-1', 'www.ybonnel.fr');
      ga('send', 'pageview');

    </script>
    
  </body>
</html>

